<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Huerto â€” Bosque de Niebla</title>

  <!-- Chart.js + plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <style>
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CSS CUSTOM PROPERTIES
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:           #0F0F1A;
      --card-bg:      #1A1A2E;
      --card-border:  #2A2A4A;
      --text:         #E8E8F0;
      --muted:        #8888AA;
      --accent-green: #00D68F;
      --accent-yellow:#FFB800;
      --accent-red:   #FF4757;
      --accent-blue:  #4ECDC4;
      --accent-purple:#A855F7;
      --navy:         #1E1E3F;
      --bar-track:    #2A2A4A;
      --radius:       12px;
      --radius-sm:    8px;
      --transition:   0.3s ease;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESET & BASE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { font-size: 16px; scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      line-height: 1.5;
      min-height: 100vh;
      padding: 0 0 2rem;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       TYPOGRAPHY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.02em; }
    h2 { font-size: 1.1rem; font-weight: 600; letter-spacing: -0.01em; margin-bottom: 1rem; }
    h3 { font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--muted); }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LAYOUT CONTAINERS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .page-wrapper {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.25rem;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

    section { margin-bottom: 1.5rem; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CARD
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 1.25rem;
      transition: border-color var(--transition);
    }
    .card:hover { border-color: #3A3A6A; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       HEADER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .site-header {
      background: var(--navy);
      border-bottom: 1px solid var(--card-border);
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }

    .header-inner {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-left { display: flex; align-items: center; gap: 0.75rem; }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background var(--transition);
      box-shadow: 0 0 0 3px transparent;
    }
    .status-dot.green  { background: var(--accent-green);  box-shadow: 0 0 0 3px rgba(0,214,143,0.2); }
    .status-dot.yellow { background: var(--accent-yellow); box-shadow: 0 0 0 3px rgba(255,184,0,0.2); }
    .status-dot.red    { background: var(--accent-red);    box-shadow: 0 0 0 3px rgba(255,71,87,0.2); }

    .header-title h1 { font-size: 1.15rem; }
    .header-title p  { font-size: 0.75rem; color: var(--muted); margin-top: 0.1rem; }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .update-info { text-align: right; }
    .update-info .label { font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.06em; }
    .update-info .value { font-size: 0.85rem; font-weight: 600; color: var(--text); }

    .refresh-btn {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 50%;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      font-size: 1rem;
      transition: all var(--transition);
      flex-shrink: 0;
    }
    .refresh-btn:hover { background: var(--card-border); border-color: var(--accent-blue); color: var(--accent-blue); }
    .refresh-btn.spinning svg { animation: spin 1s linear infinite; }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       KPI CARDS
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .kpi-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .kpi-value {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1;
      color: var(--text);
      letter-spacing: -0.03em;
    }

    .kpi-unit {
      font-size: 1rem;
      font-weight: 400;
      color: var(--muted);
      margin-left: 0.2rem;
    }

    .kpi-sub {
      font-size: 0.78rem;
      color: var(--muted);
      margin-top: 0.15rem;
    }

    .kpi-icon {
      font-size: 1.4rem;
      margin-bottom: 0.25rem;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SOIL MOISTURE SECTION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .soil-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .soil-avg {
      display: flex;
      align-items: baseline;
      gap: 0.4rem;
    }

    .soil-avg-value {
      font-size: 3rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.04em;
    }

    .soil-avg-label {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .soil-legend {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Progress bar rows */
    .soil-channels { display: flex; flex-direction: column; gap: 0.85rem; }

    .channel-row {
      display: grid;
      grid-template-columns: 60px 1fr 50px;
      align-items: center;
      gap: 0.75rem;
    }

    .channel-label {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--muted);
    }

    .progress-track {
      position: relative;
      background: var(--bar-track);
      border-radius: 100px;
      height: 14px;
      overflow: visible;
    }

    .progress-fill {
      height: 100%;
      border-radius: 100px;
      transition: width 0.8s cubic-bezier(0.4,0,0.2,1), background 0.4s ease;
      position: relative;
      z-index: 1;
    }

    /* Threshold markers on the bar */
    .threshold-marker {
      position: absolute;
      top: -5px;
      bottom: -5px;
      width: 2px;
      border-radius: 2px;
      z-index: 2;
    }
    .threshold-marker.dry   { background: var(--accent-red);    left: 35%; }
    .threshold-marker.opt   { background: var(--accent-green);  left: 50%; }
    .threshold-marker.wet   { background: var(--accent-blue);   left: 80%; }

    .threshold-marker::after {
      content: attr(data-label);
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .channel-pct {
      font-size: 0.9rem;
      font-weight: 700;
      text-align: right;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ALERT BANNER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .alert-banner {
      background: rgba(255, 71, 87, 0.12);
      border: 1px solid var(--accent-red);
      border-radius: var(--radius);
      padding: 1rem 1.25rem;
      display: none;
      margin-bottom: 1.5rem;
    }

    .alert-banner.visible { display: block; }

    .alert-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent-red);
      margin-bottom: 0.5rem;
    }

    .alert-items { display: flex; flex-direction: column; gap: 0.25rem; }

    .alert-item {
      font-size: 0.85rem;
      color: #FF8A95;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CLIMA GRID
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .clima-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .mini-card {
      background: var(--navy);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      padding: 0.85rem 1rem;
    }

    .mini-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .mini-value {
      font-size: 1.35rem;
      font-weight: 700;
      line-height: 1.1;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RAIN SECTION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rain-layout {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 1.5rem;
      align-items: center;
    }

    .rain-rate-block { text-align: center; }

    .rain-rate-value {
      font-size: 2.8rem;
      font-weight: 800;
      letter-spacing: -0.04em;
      color: var(--accent-blue);
    }

    .rain-rate-label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .rain-accumulations {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.75rem;
    }

    .rain-acc-item { text-align: center; }

    .rain-acc-value {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--accent-blue);
    }

    .rain-acc-label {
      font-size: 0.65rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       BATTERY TABLE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .battery-table {
      width: 100%;
      border-collapse: collapse;
    }

    .battery-table th {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-align: left;
      padding: 0 0 0.6rem;
      border-bottom: 1px solid var(--card-border);
    }

    .battery-table td {
      font-size: 0.85rem;
      padding: 0.55rem 0;
      border-bottom: 1px solid rgba(42,42,74,0.6);
      vertical-align: middle;
    }

    .battery-table tr:last-child td { border-bottom: none; }

    .batt-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      font-weight: 600;
      padding: 0.2rem 0.6rem;
      border-radius: 100px;
    }

    .batt-badge.ok     { background: rgba(0,214,143,0.12); color: var(--accent-green); }
    .batt-badge.medium { background: rgba(255,184,0,0.12);  color: var(--accent-yellow); }
    .batt-badge.low    { background: rgba(255,71,87,0.12);  color: var(--accent-red); }

    .batt-icon { font-size: 0.8rem; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       CHART SECTION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-wrapper {
      position: relative;
      height: 340px;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       LOADING SKELETON
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .skeleton {
      background: linear-gradient(90deg, var(--card-border) 25%, #3A3A5A 50%, var(--card-border) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: var(--radius-sm);
    }

    @keyframes shimmer {
      0%   { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-text   { height: 1rem;  margin-bottom: 0.4rem; }
    .skeleton-big    { height: 2.5rem; margin-bottom: 0.5rem; }
    .skeleton-bar    { height: 14px; border-radius: 100px; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       ERROR STATE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .error-inline {
      background: rgba(255,71,87,0.08);
      border: 1px solid rgba(255,71,87,0.3);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      font-size: 0.82rem;
      color: #FF8A95;
      margin-top: 0.5rem;
      display: none;
    }
    .error-inline.visible { display: block; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SECTION TITLE ROW
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 1rem;
    }

    .section-icon { font-size: 1.1rem; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       DIVIDER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .divider {
      height: 1px;
      background: var(--card-border);
      margin: 1.5rem 0;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       RESPONSIVE
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 900px) {
      .grid-4     { grid-template-columns: repeat(2, 1fr); }
      .clima-grid { grid-template-columns: repeat(2, 1fr); }
      .rain-accumulations { grid-template-columns: repeat(3, 1fr); }
      .rain-layout { grid-template-columns: 1fr; text-align: center; }
      .rain-rate-block { order: -1; }
    }

    @media (max-width: 600px) {
      .grid-4     { grid-template-columns: 1fr 1fr; }
      .grid-2     { grid-template-columns: 1fr; }
      .clima-grid { grid-template-columns: 1fr 1fr; }
      .rain-accumulations { grid-template-columns: repeat(2, 1fr); }
      .header-inner { gap: 0.5rem; }
      .kpi-value  { font-size: 1.6rem; }
      .chart-wrapper { height: 260px; }
      .soil-avg-value { font-size: 2.2rem; }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       COUNTDOWN PILL
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .countdown-pill {
      background: var(--navy);
      border: 1px solid var(--card-border);
      border-radius: 100px;
      padding: 0.25rem 0.75rem;
      font-size: 0.72rem;
      color: var(--muted);
      white-space: nowrap;
    }
    .countdown-pill span { color: var(--accent-green); font-weight: 600; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       BED MAP SECTION
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bed-map-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .bed-map-legend {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .bed-map-legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .bed-map-legend-swatch {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      border: 2px solid currentColor;
      flex-shrink: 0;
    }

    /* Beds grid â€” 6 columns */
    .beds-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    /* Each bed card */
    .bed-card {
      position: relative;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-left: 4px solid var(--card-border);
      border-radius: var(--radius-sm);
      padding: 0.7rem 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      transition: border-color var(--transition), box-shadow var(--transition);
      min-height: 110px;
    }

    .bed-card.glow-green {
      border-left-color: #90EE90;
      box-shadow: 0 0 0 1px rgba(144,238,144,0.25), 0 0 12px rgba(144,238,144,0.12);
    }
    .bed-card.glow-yellow {
      border-left-color: var(--accent-yellow);
      box-shadow: 0 0 0 1px rgba(255,184,0,0.25), 0 0 12px rgba(255,184,0,0.12);
    }
    .bed-card.glow-red {
      border-left-color: var(--accent-red);
      box-shadow: 0 0 0 1px rgba(255,71,87,0.3), 0 0 14px rgba(255,71,87,0.2);
      animation: pulse-red 1.8s ease-in-out infinite;
    }
    .bed-card.glow-blue {
      border-left-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(78,205,196,0.25), 0 0 12px rgba(78,205,196,0.1);
    }

    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 1px rgba(255,71,87,0.3), 0 0 14px rgba(255,71,87,0.2); }
      50%       { box-shadow: 0 0 0 2px rgba(255,71,87,0.5), 0 0 22px rgba(255,71,87,0.35); }
    }

    /* Group border colors when no humidity data yet */
    .bed-card[data-group="hojas"]    { border-left-color: #90EE90; }
    .bed-card[data-group="hierbas"]  { border-left-color: #32CD32; }
    .bed-card[data-group="brasicas"] { border-left-color: #228B22; }
    .bed-card[data-group="rotacion"] { border-left-color: #DEB887; }

    .bed-card-name {
      font-size: 0.72rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      line-height: 1.1;
    }

    .bed-card-crops {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      flex: 1;
    }

    .bed-crop-item {
      font-size: 0.75rem;
      color: var(--text);
      line-height: 1.3;
    }

    .bed-humidity {
      font-size: 1.1rem;
      font-weight: 800;
      line-height: 1;
      letter-spacing: -0.02em;
      margin-top: 0.2rem;
    }

    .bed-humidity-sub {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 0.1rem;
    }

    .bed-no-sensor {
      font-size: 0.72rem;
      color: var(--muted);
      font-style: italic;
      margin-top: auto;
    }

    /* Greenhouse card â€” full width below */
    .greenhouse-card {
      background: rgba(135, 206, 235, 0.06);
      border: 1px solid rgba(135, 206, 235, 0.2);
      border-left: 4px solid #87CEEB;
      border-radius: var(--radius-sm);
      padding: 1rem 1.25rem;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 1rem;
    }

    .greenhouse-icon {
      font-size: 2rem;
      line-height: 1;
    }

    .greenhouse-title {
      font-size: 0.82rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #87CEEB;
      margin-bottom: 0.3rem;
    }

    .greenhouse-crops {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 0.25rem;
    }

    .greenhouse-crop {
      font-size: 0.82rem;
      color: var(--text);
    }

    .greenhouse-note {
      font-size: 0.72rem;
      color: var(--muted);
      font-style: italic;
    }

    .greenhouse-dims {
      text-align: right;
    }

    .greenhouse-dims-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #87CEEB;
    }

    .greenhouse-dims-label {
      font-size: 0.65rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Row labels above each row of beds */
    .beds-row-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--muted);
      margin-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .beds-row-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--card-border);
    }

    /* Responsive beds grid */
    @media (max-width: 1024px) {
      .beds-grid { grid-template-columns: repeat(3, 1fr); }
      .greenhouse-card { grid-template-columns: auto 1fr; }
      .greenhouse-dims { display: none; }
    }
    @media (max-width: 600px) {
      .beds-grid { grid-template-columns: repeat(2, 1fr); }
      .greenhouse-card { grid-template-columns: 1fr; }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       NOTIFICATION CENTER
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notif-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .notif-header-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .notif-badges {
      display: flex;
      gap: 0.4rem;
    }

    .notif-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.72rem;
      font-weight: 700;
      padding: 0.15rem 0.5rem;
      border-radius: 100px;
    }
    .notif-badge.critical { background: rgba(255,71,87,0.15); color: var(--accent-red); }
    .notif-badge.warning  { background: rgba(255,184,0,0.15);  color: var(--accent-yellow); }
    .notif-badge.info     { background: rgba(0,214,143,0.12); color: var(--accent-green); }

    .notif-timestamp {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .notif-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .notif-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.65rem 0.85rem;
      background: var(--navy);
      border-radius: var(--radius-sm);
      border-left: 4px solid transparent;
      transition: border-color var(--transition);
    }

    .notif-item.severity-critical {
      border-left-color: var(--accent-red);
      background: rgba(255,71,87,0.07);
    }
    .notif-item.severity-warning {
      border-left-color: var(--accent-yellow);
      background: rgba(255,184,0,0.06);
    }
    .notif-item.severity-info {
      border-left-color: var(--accent-green);
      background: rgba(0,214,143,0.05);
    }
    .notif-item.severity-rain {
      border-left-color: var(--accent-blue);
      background: rgba(78,205,196,0.06);
    }

    .notif-icon {
      font-size: 1rem;
      line-height: 1.4;
    }

    .notif-msg {
      font-size: 0.83rem;
      line-height: 1.45;
      color: var(--text);
    }

    .notif-time {
      font-size: 0.68rem;
      color: var(--muted);
      white-space: nowrap;
      line-height: 1.4;
    }

    .notif-empty {
      text-align: center;
      padding: 1.5rem;
      color: var(--muted);
      font-size: 0.85rem;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PLANT EDIT BUTTON
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bed-card {
      position: relative;
    }

    .bed-edit-btn {
      position: absolute;
      top: 0.4rem;
      right: 0.4rem;
      z-index: 1;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0.1rem 0.25rem;
      line-height: 1;
      opacity: 0;
      transition: opacity var(--transition), border-color var(--transition), color var(--transition);
    }

    .bed-card:hover .bed-edit-btn,
    .greenhouse-card:hover .bed-edit-btn {
      opacity: 1;
    }

    .bed-edit-btn:hover {
      border-color: var(--card-border);
      color: var(--accent-blue);
    }

    .greenhouse-card {
      position: relative;
    }

    .greenhouse-edit-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 4px;
      color: var(--muted);
      font-size: 0.75rem;
      cursor: pointer;
      padding: 0.1rem 0.25rem;
      line-height: 1;
      opacity: 0;
      transition: opacity var(--transition), border-color var(--transition), color var(--transition);
    }

    .greenhouse-card:hover .greenhouse-edit-btn {
      opacity: 1;
    }

    .greenhouse-edit-btn:hover {
      border-color: rgba(135,206,235,0.4);
      color: #87CEEB;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PLANT MODAL OVERLAY
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plant-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .plant-modal-overlay.open {
      display: flex;
    }

    .plant-modal {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 1.25rem;
      width: 100%;
      max-width: 380px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    }

    .plant-modal-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid var(--card-border);
    }

    .plant-modal-section-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 0.5rem;
      margin-top: 0.75rem;
    }

    .plant-current-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      min-height: 1.5rem;
    }

    .plant-current-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--navy);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      padding: 0.4rem 0.65rem;
      font-size: 0.82rem;
      color: var(--text);
    }

    .plant-remove-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1;
      padding: 0 0.15rem;
      transition: color var(--transition);
    }

    .plant-remove-btn:hover {
      color: var(--accent-red);
    }

    .plant-empty-msg {
      font-size: 0.78rem;
      color: var(--muted);
      font-style: italic;
      padding: 0.25rem 0;
    }

    .plant-add-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-top: 0.5rem;
    }

    .plant-select {
      flex: 1;
      background: var(--navy);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.82rem;
      padding: 0.45rem 0.6rem;
      cursor: pointer;
      outline: none;
      transition: border-color var(--transition);
    }

    .plant-select:focus {
      border-color: var(--accent-blue);
    }

    .plant-select option {
      background: #1A1A2E;
      color: var(--text);
    }

    .plant-select optgroup {
      background: #0F0F1A;
      color: var(--muted);
      font-size: 0.75rem;
    }

    .plant-add-btn {
      background: var(--accent-green);
      border: none;
      border-radius: var(--radius-sm);
      color: #0F0F1A;
      font-size: 0.8rem;
      font-weight: 700;
      padding: 0.45rem 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity var(--transition);
    }

    .plant-add-btn:hover {
      opacity: 0.85;
    }

    .plant-add-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .plant-modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--card-border);
    }

    .plant-close-btn {
      background: var(--card-border);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text);
      font-size: 0.85rem;
      font-weight: 600;
      padding: 0.5rem 1.25rem;
      cursor: pointer;
      transition: background var(--transition);
    }

    .plant-close-btn:hover {
      background: #3A3A6A;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       PLANT TOOLTIP
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plant-tooltip {
      position: fixed;
      background: #0F0F1A;
      border: 1px solid var(--card-border);
      border-radius: var(--radius-sm);
      padding: 0.55rem 0.75rem;
      font-size: 0.75rem;
      color: var(--text);
      z-index: 2000;
      pointer-events: none;
      display: none;
      max-width: 220px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      line-height: 1.5;
    }

    .plant-tooltip.visible {
      display: block;
    }

    .plant-tooltip-name {
      font-weight: 700;
      margin-bottom: 0.3rem;
      color: var(--accent-green);
    }

    .plant-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      color: var(--muted);
    }

    .plant-tooltip-row span:last-child {
      color: var(--text);
      font-weight: 600;
    }

    .bed-crop-item {
      cursor: default;
    }

    .bed-crop-item[data-plant-id] {
      cursor: help;
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       SENSOR ASSIGNMENT SYSTEM
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bed-sensor-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-top: 0.2rem;
    }

    .bed-sensor-select {
      position: relative;
      z-index: 2;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--card-border);
      border-radius: 4px;
      font-size: 0.65rem;
      padding: 0.15rem 0.3rem;
      width: 100%;
      cursor: pointer;
      -webkit-appearance: menulist;
    }

    .bed-sensor-select:focus {
      border-color: var(--accent-green);
      outline: none;
    }

    .bed-sensor-select option:disabled {
      color: var(--muted);
    }

    .bed-live-badge {
      display: inline-block;
      background: var(--accent-green);
      color: #000;
      font-size: 0.55rem;
      font-weight: 700;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-left: 0.3rem;
      flex-shrink: 0;
    }

    .bed-cached-info {
      font-size: 0.6rem;
      color: var(--muted);
      font-style: italic;
    }

    .bed-humidity-cached {
      font-size: 1.1rem;
      font-weight: 800;
      line-height: 1;
      opacity: 0.6;
    }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <header class="site-header">
    <div class="header-inner">
      <div class="header-left">
        <div class="status-dot" id="statusDot"></div>
        <div class="header-title">
          <h1>Huerto â€” Bosque de Niebla</h1>
          <p>1,780 msnm &middot; ZipacÃ³n, Cundinamarca</p>
        </div>
      </div>

      <div class="header-right">
        <div class="update-info">
          <div class="label">Ãšltima actualizaciÃ³n</div>
          <div class="value" id="lastUpdated">â€”</div>
        </div>
        <div class="countdown-pill">PrÃ³xima: <span id="countdownDisplay">5:00</span></div>
        <button class="refresh-btn" id="refreshBtn" title="Actualizar ahora" onclick="manualRefresh()">
          <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
            <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PAGE CONTENT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="page-wrapper">

    <!-- Error banner (global) -->
    <div class="error-inline" id="globalError"></div>

    <!-- â”€â”€ 1. KPI CARDS â”€â”€ -->
    <section>
      <div class="grid-4" id="kpiGrid">
        <!-- Temperatura exterior -->
        <div class="card kpi-card">
          <div class="kpi-icon">ğŸŒ¡ï¸</div>
          <div class="kpi-label">Temperatura Exterior</div>
          <div class="kpi-value"><span id="kpiTempExt">â€”</span><span class="kpi-unit">Â°C</span></div>
          <div class="kpi-sub" id="kpiFeelsLike">SensaciÃ³n: â€”</div>
        </div>

        <!-- Humedad aire -->
        <div class="card kpi-card">
          <div class="kpi-icon">ğŸ’§</div>
          <div class="kpi-label">Humedad del Aire</div>
          <div class="kpi-value"><span id="kpiHumExt">â€”</span><span class="kpi-unit">%</span></div>
          <div class="kpi-sub" id="kpiDewPoint">RocÃ­o: â€”</div>
        </div>

        <!-- PresiÃ³n -->
        <div class="card kpi-card">
          <div class="kpi-icon">ğŸŒ€</div>
          <div class="kpi-label">PresiÃ³n Relativa</div>
          <div class="kpi-value"><span id="kpiPressure">â€”</span><span class="kpi-unit">hPa</span></div>
          <div class="kpi-sub" id="kpiAbsPressure">Abs: â€”</div>
        </div>

        <!-- Lluvia del dÃ­a -->
        <div class="card kpi-card">
          <div class="kpi-icon">ğŸŒ§ï¸</div>
          <div class="kpi-label">Lluvia del DÃ­a</div>
          <div class="kpi-value"><span id="kpiRainDay">â€”</span><span class="kpi-unit">mm</span></div>
          <div class="kpi-sub" id="kpiRainRate">Tasa: â€” mm/hr</div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 2. HUMEDAD DEL SUELO â”€â”€ -->
    <section>
      <div class="card">
        <div class="soil-header">
          <div>
            <div class="section-title-row">
              <span class="section-icon">ğŸŒ±</span>
              <h2 style="margin-bottom:0">Humedad del Suelo</h2>
            </div>
            <div class="soil-avg">
              <div class="soil-avg-value" id="soilAvgValue" style="color: var(--accent-green)">â€”</div>
              <div class="soil-avg-label">% promedio</div>
            </div>
          </div>
          <div class="soil-legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--accent-red)"></div>Seco &lt;35%</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--accent-yellow)"></div>Bajo 35â€“50%</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--accent-green)"></div>Ã“ptimo 50â€“80%</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--accent-blue)"></div>HÃºmedo &gt;80%</div>
          </div>
        </div>

        <div class="soil-channels" id="soilChannels">
          <!-- Dynamically generated -->
          <div class="skeleton skeleton-bar" style="width:100%;height:14px;margin-bottom:0.5rem"></div>
          <div class="skeleton skeleton-bar" style="width:100%;height:14px;margin-bottom:0.5rem"></div>
          <div class="skeleton skeleton-bar" style="width:100%;height:14px;margin-bottom:0.5rem"></div>
          <div class="skeleton skeleton-bar" style="width:100%;height:14px;margin-bottom:0.5rem"></div>
          <div class="skeleton skeleton-bar" style="width:100%;height:14px"></div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 3. MAPA DE LA HUERTA â”€â”€ -->
    <section id="bedMapSection">
      <div class="card">
        <div class="bed-map-header">
          <div class="section-title-row" style="margin-bottom:0">
            <span class="section-icon">ğŸ—ºï¸</span>
            <h2 style="margin-bottom:0">Mapa de la Huerta</h2>
          </div>
          <div class="bed-map-legend">
            <div class="bed-map-legend-item" style="color:#90EE90">
              <div class="bed-map-legend-swatch" style="border-color:#90EE90"></div>Hojas
            </div>
            <div class="bed-map-legend-item" style="color:#32CD32">
              <div class="bed-map-legend-swatch" style="border-color:#32CD32"></div>Hierbas
            </div>
            <div class="bed-map-legend-item" style="color:#228B22">
              <div class="bed-map-legend-swatch" style="border-color:#228B22"></div>BrÃ¡sicas
            </div>
            <div class="bed-map-legend-item" style="color:#DEB887">
              <div class="bed-map-legend-swatch" style="border-color:#DEB887"></div>RotaciÃ³n
            </div>
            <div class="bed-map-legend-item" style="color:#87CEEB">
              <div class="bed-map-legend-swatch" style="border-color:#87CEEB"></div>Invernadero
            </div>
          </div>
        </div>

        <!-- DisposiciÃ³n real: 2 columnas (Impares derecha, Pares izquierda) -->
        <div class="beds-row-label">Derecha â€” Impares (1, 3, 5, 7, 9, 11)</div>
        <div class="beds-grid" id="bedsRow1">
          <!-- Filled by JS: odd beds -->
        </div>

        <div class="beds-row-label">Izquierda â€” Pares (2, 4, 6, 8, 10, 12)</div>
        <div class="beds-grid" id="bedsRow2">
          <!-- Filled by JS: even beds -->
        </div>

        <!-- Greenhouse -->
        <div class="beds-row-label">Invernadero</div>
        <div class="greenhouse-card" id="greenhouseCard">
          <button class="greenhouse-edit-btn" onclick="openPlantModal('invernadero')" title="Editar plantas">âœï¸</button>
          <div class="greenhouse-icon">ğŸ¡</div>
          <div>
            <div class="greenhouse-title">Invernadero Â· 5.6m Ã— 6m</div>
            <div class="greenhouse-crops" id="greenhouseCropsDisplay">
              <!-- Filled by JS -->
            </div>
            <div class="greenhouse-note" id="greenhouseNote">Sensor CH4 Â· Ã“ptimo tomate: 20â€“30%</div>
            <div class="bed-sensor-row" style="margin-top:0.4rem;max-width:180px">
              <select class="bed-sensor-select" id="greenhouseSensorSelect" onchange="assignSensorToBed('invernadero', this.value)">
                <!-- Filled by JS -->
              </select>
            </div>
          </div>
          <div class="greenhouse-dims">
            <div class="greenhouse-dims-value" id="greenhouseHumidity">â€”</div>
            <div class="greenhouse-dims-label" id="greenhouseDimsLabel">Humedad suelo</div>
          </div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 4. ALERT BANNER â”€â”€ -->
    <div class="alert-banner" id="alertBanner">
      <div class="alert-title">Alerta de Riego</div>
      <div class="alert-items" id="alertItems"></div>
    </div>

    <!-- â”€â”€ 5. CLIMA COMPLETO â”€â”€ -->
    <section>
      <div class="card">
        <div class="section-title-row">
          <span class="section-icon">ğŸŒ¤ï¸</span>
          <h2 style="margin-bottom:0">Clima Completo</h2>
        </div>
        <div class="clima-grid">
          <div class="mini-card">
            <div class="mini-label">Temp. Exterior</div>
            <div class="mini-value" id="climaTempExt">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Temp. Interior (GW)</div>
            <div class="mini-value" id="climaTempInt">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Hum. Exterior</div>
            <div class="mini-value" id="climaHumExt">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Hum. Interior (GW)</div>
            <div class="mini-value" id="climaHumInt">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Punto de RocÃ­o</div>
            <div class="mini-value" id="climaDewPoint">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">SensaciÃ³n TÃ©rmica</div>
            <div class="mini-value" id="climaFeelsLike">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Temp. CH1 (WN31)</div>
            <div class="mini-value" id="climaTempCh1">â€”</div>
          </div>
          <div class="mini-card">
            <div class="mini-label">Hum. CH1 (WN31)</div>
            <div class="mini-value" id="climaHumCh1">â€”</div>
          </div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 6. LLUVIA â”€â”€ -->
    <section>
      <div class="card">
        <div class="section-title-row">
          <span class="section-icon">ğŸŒ§ï¸</span>
          <h2 style="margin-bottom:0">Lluvia</h2>
        </div>
        <div class="rain-layout">
          <div class="rain-rate-block">
            <div class="rain-rate-value" id="rainRateValue">0.0</div>
            <div class="rain-rate-label">mm/hr Â· tasa actual</div>
          </div>
          <div class="rain-accumulations">
            <div class="rain-acc-item">
              <div class="rain-acc-value" id="rain1h">â€”</div>
              <div class="rain-acc-label">1 hora</div>
            </div>
            <div class="rain-acc-item">
              <div class="rain-acc-value" id="rainDay2">â€”</div>
              <div class="rain-acc-label">Hoy</div>
            </div>
            <div class="rain-acc-item">
              <div class="rain-acc-value" id="rainWeek">â€”</div>
              <div class="rain-acc-label">Semana</div>
            </div>
            <div class="rain-acc-item">
              <div class="rain-acc-value" id="rainMonth">â€”</div>
              <div class="rain-acc-label">Mes</div>
            </div>
            <div class="rain-acc-item">
              <div class="rain-acc-value" id="rainYear">â€”</div>
              <div class="rain-acc-label">AÃ±o</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 7. BATERÃA â”€â”€ -->
    <section>
      <div class="card">
        <div class="section-title-row">
          <span class="section-icon">ğŸ”‹</span>
          <h2 style="margin-bottom:0">BaterÃ­a de Sensores</h2>
        </div>
        <table class="battery-table">
          <thead>
            <tr>
              <th>Sensor</th>
              <th>Nivel</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="batteryTableBody">
            <tr><td colspan="3"><div class="skeleton skeleton-text" style="width:60%"></div></td></tr>
            <tr><td colspan="3"><div class="skeleton skeleton-text" style="width:50%"></div></td></tr>
            <tr><td colspan="3"><div class="skeleton skeleton-text" style="width:70%"></div></td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- â”€â”€ 8. CENTRO DE NOTIFICACIONES â”€â”€ -->
    <section id="notifSection">
      <div class="card">
        <div class="notif-header">
          <div class="notif-header-left">
            <div class="section-title-row" style="margin-bottom:0">
              <span class="section-icon">ğŸ””</span>
              <h2 style="margin-bottom:0">Notificaciones</h2>
            </div>
            <div class="notif-badges" id="notifBadges">
              <!-- Filled by JS -->
            </div>
          </div>
          <div class="notif-timestamp" id="notifTimestamp">â€”</div>
        </div>
        <div class="notif-list" id="notifList">
          <div class="skeleton skeleton-text" style="width:90%"></div>
          <div class="skeleton skeleton-text" style="width:75%"></div>
          <div class="skeleton skeleton-text" style="width:82%"></div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ 9. HISTORIAL 24H â”€â”€ -->
    <section>
      <div class="card">
        <div class="section-title-row">
          <span class="section-icon">ğŸ“ˆ</span>
          <h2 style="margin-bottom:0">Historial 24 horas</h2>
        </div>
        <div class="error-inline" id="historyError"></div>
        <div class="chart-wrapper">
          <canvas id="historyChart"></canvas>
        </div>
      </div>
    </section>

  </div><!-- .page-wrapper -->

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       PLANT SELECTION MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="plant-modal-overlay" id="plantModalOverlay" onclick="handleOverlayClick(event)">
    <div class="plant-modal" id="plantModal">
      <div class="plant-modal-title" id="plantModalTitle">Editar plantas â€” Cama X</div>

      <div class="plant-modal-section-label">Plantas actuales (mÃ¡x. 3)</div>
      <div class="plant-current-list" id="plantCurrentList"></div>

      <div class="plant-modal-section-label">Agregar planta</div>
      <div class="plant-add-row">
        <select class="plant-select" id="plantSelectDropdown">
          <option value="">â€” Seleccionar planta â€”</option>
        </select>
        <button class="plant-add-btn" id="plantAddBtn" onclick="addPlantToCurrentBed()">Agregar</button>
      </div>

      <div class="plant-modal-footer">
        <button class="plant-close-btn" onclick="closePlantModal()">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- Plant tooltip (global, moved on mousemove) -->
  <div class="plant-tooltip" id="plantTooltip"></div>


  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       JAVASCRIPT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
  'use strict';

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     PLANT CATALOG
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const PLANT_CATALOG = [
    // HOJAS
    { id: 'lechuga_batavia',   nombre: 'Lechuga Batavia',   emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '40-55',   espaciamiento: 25, humMin: 30, humMax: 50, tempMin: 10, tempMax: 24, companeras: ['zanahoria','remolacha','cebolla'], enemigos: ['perejil','apio'] },
    { id: 'lechuga_romana',    nombre: 'Lechuga Romana',    emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '50-65',   espaciamiento: 30, humMin: 30, humMax: 50, tempMin: 10, tempMax: 24, companeras: ['zanahoria','remolacha','cebolla'], enemigos: ['perejil','apio'] },
    { id: 'lechuga_crespa',    nombre: 'Lechuga Crespa',    emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '35-50',   espaciamiento: 25, humMin: 30, humMax: 50, tempMin: 10, tempMax: 24, companeras: ['zanahoria','remolacha','cebolla'], enemigos: ['perejil','apio'] },
    { id: 'rucula',            nombre: 'RÃºcula',            emoji: 'ğŸ¥—', grupo: 'hojas',       dias: '25-35',   espaciamiento: 15, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 22, companeras: ['lechuga','espinaca','zanahoria'],  enemigos: ['brassicas'] },
    { id: 'espinaca',          nombre: 'Espinaca',          emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '35-50',   espaciamiento: 15, humMin: 35, humMax: 55, tempMin: 5,  tempMax: 22, companeras: ['lechuga','acelga','remolacha'],    enemigos: ['girasol'] },
    { id: 'acelga_comun',      nombre: 'Acelga ComÃºn',      emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '50-65',   espaciamiento: 25, humMin: 35, humMax: 55, tempMin: 8,  tempMax: 24, companeras: ['lechuga','cebolla','zanahoria'],   enemigos: ['maiz'] },
    { id: 'acelga_roja',       nombre: 'Acelga Roja',       emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '50-65',   espaciamiento: 25, humMin: 35, humMax: 55, tempMin: 8,  tempMax: 24, companeras: ['lechuga','cebolla'],              enemigos: ['maiz'] },
    { id: 'acelga_amarilla',   nombre: 'Acelga Amarilla',   emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '50-65',   espaciamiento: 25, humMin: 35, humMax: 55, tempMin: 8,  tempMax: 24, companeras: ['lechuga','cebolla'],              enemigos: ['maiz'] },
    { id: 'mizuna_verde',      nombre: 'Mizuna Verde',      emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '30-40',   espaciamiento: 20, humMin: 30, humMax: 50, tempMin: 5,  tempMax: 25, companeras: ['lechuga','espinaca'],             enemigos: [] },
    { id: 'mizuna_roja',       nombre: 'Mizuna Roja',       emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '30-40',   espaciamiento: 20, humMin: 30, humMax: 50, tempMin: 5,  tempMax: 25, companeras: ['lechuga','espinaca'],             enemigos: [] },
    { id: 'mostaza_red',       nombre: 'Mostaza Red',       emoji: 'ğŸŒ¿', grupo: 'hojas',       dias: '30-45',   espaciamiento: 20, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 24, companeras: ['lechuga','espinaca'],             enemigos: [] },
    { id: 'tat_soi',           nombre: 'Tat Soi',           emoji: 'ğŸ¥¬', grupo: 'hojas',       dias: '30-45',   espaciamiento: 20, humMin: 35, humMax: 55, tempMin: 3,  tempMax: 25, companeras: ['lechuga','cebolla'],              enemigos: ['brassicas'] },
    // AROMÃTICAS
    { id: 'albahaca',          nombre: 'Albahaca',          emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '50-70',   espaciamiento: 25, humMin: 25, humMax: 45, tempMin: 15, tempMax: 30, companeras: ['tomate','pimiento'],              enemigos: ['salvia','ruda'] },
    { id: 'albahaca_morada',   nombre: 'Albahaca Morada',   emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '50-70',   espaciamiento: 25, humMin: 25, humMax: 45, tempMin: 15, tempMax: 30, companeras: ['tomate','pimiento'],              enemigos: ['salvia','ruda'] },
    { id: 'perejil_liso',      nombre: 'Perejil Liso',      emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '60-80',   espaciamiento: 15, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 25, companeras: ['tomate','zanahoria'],             enemigos: ['lechuga'] },
    { id: 'cilantro',          nombre: 'Cilantro',          emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '40-55',   espaciamiento: 10, humMin: 30, humMax: 50, tempMin: 10, tempMax: 25, companeras: ['tomate','espinaca'],              enemigos: ['hinojo'] },
    { id: 'oregano',           nombre: 'OrÃ©gano',           emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '80-100',  espaciamiento: 30, humMin: 20, humMax: 40, tempMin: 10, tempMax: 30, companeras: ['tomate','pimiento','albahaca'],   enemigos: [] },
    { id: 'tomillo',           nombre: 'Tomillo',           emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '80-100',  espaciamiento: 25, humMin: 20, humMax: 35, tempMin: 8,  tempMax: 28, companeras: ['repollo','fresa','zanahoria'],    enemigos: [] },
    { id: 'cebollin',          nombre: 'CebollÃ­n',          emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '60-80',   espaciamiento: 15, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 25, companeras: ['zanahoria','tomate','lechuga'],   enemigos: ['frijol','arveja'] },
    { id: 'menta',             nombre: 'Menta',             emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '60-90',   espaciamiento: 30, humMin: 35, humMax: 60, tempMin: 5,  tempMax: 25, companeras: ['tomate','repollo'],               enemigos: ['manzanilla'] },
    { id: 'romero',            nombre: 'Romero',            emoji: 'ğŸŒ¿', grupo: 'aromaticas',  dias: '120-180', espaciamiento: 40, humMin: 15, humMax: 35, tempMin: 8,  tempMax: 30, companeras: ['repollo','zanahoria','frijol'],   enemigos: [] },
    // BRÃSICAS
    { id: 'brocoli',           nombre: 'BrÃ³coli',           emoji: 'ğŸ¥¦', grupo: 'brasicas',    dias: '60-80',   espaciamiento: 40, humMin: 30, humMax: 50, tempMin: 10, tempMax: 24, companeras: ['cebolla','menta','romero'],       enemigos: ['tomate','fresa'] },
    { id: 'coliflor_blanca',   nombre: 'Coliflor Blanca',   emoji: 'ğŸ¥¦', grupo: 'brasicas',    dias: '70-90',   espaciamiento: 45, humMin: 30, humMax: 50, tempMin: 10, tempMax: 22, companeras: ['cebolla','apio','menta'],         enemigos: ['tomate','fresa'] },
    { id: 'coliflor_verde',    nombre: 'Coliflor Verde',    emoji: 'ğŸ¥¦', grupo: 'brasicas',    dias: '70-90',   espaciamiento: 45, humMin: 30, humMax: 50, tempMin: 10, tempMax: 22, companeras: ['cebolla','apio'],                 enemigos: ['tomate','fresa'] },
    { id: 'repollo_verde',     nombre: 'Repollo Verde',     emoji: 'ğŸ¥¬', grupo: 'brasicas',    dias: '80-100',  espaciamiento: 40, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 24, companeras: ['cebolla','menta','tomillo'],      enemigos: ['tomate','fresa'] },
    { id: 'repollo_morado',    nombre: 'Repollo Morado',    emoji: 'ğŸ¥¬', grupo: 'brasicas',    dias: '85-110',  espaciamiento: 40, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 24, companeras: ['cebolla','menta','tomillo'],      enemigos: ['tomate','fresa'] },
    { id: 'kale_toscano',      nombre: 'Kale Toscano',      emoji: 'ğŸ¥¬', grupo: 'brasicas',    dias: '55-70',   espaciamiento: 35, humMin: 30, humMax: 50, tempMin: 5,  tempMax: 25, companeras: ['cebolla','remolacha','cebollin'], enemigos: ['tomate','fresa'] },
    { id: 'kale_rizado',       nombre: 'Kale Rizado',       emoji: 'ğŸ¥¬', grupo: 'brasicas',    dias: '55-70',   espaciamiento: 35, humMin: 30, humMax: 50, tempMin: 5,  tempMax: 25, companeras: ['cebolla','remolacha'],            enemigos: ['tomate','fresa'] },
    // RAÃCES
    { id: 'cebolla_larga',     nombre: 'Cebolla Larga',     emoji: 'ğŸ§…', grupo: 'raices',      dias: '90-120',  espaciamiento: 10, humMin: 25, humMax: 45, tempMin: 10, tempMax: 25, companeras: ['zanahoria','lechuga','remolacha'],enemigos: ['frijol','arveja'] },
    { id: 'zanahoria',         nombre: 'Zanahoria',         emoji: 'ğŸ¥•', grupo: 'raices',      dias: '70-90',   espaciamiento: 5,  humMin: 30, humMax: 50, tempMin: 8,  tempMax: 24, companeras: ['cebolla','lechuga','tomate'],     enemigos: ['eneldo'] },
    { id: 'remolacha',         nombre: 'Remolacha',         emoji: 'ğŸ¥•', grupo: 'raices',      dias: '55-70',   espaciamiento: 10, humMin: 30, humMax: 50, tempMin: 8,  tempMax: 24, companeras: ['lechuga','cebolla','repollo'],    enemigos: ['frijol'] },
    // INVERNADERO
    { id: 'tomate_san_marzano',    nombre: 'Tomate San Marzano',    emoji: 'ğŸ…', grupo: 'invernadero', dias: '75-90', espaciamiento: 50, humMin: 20, humMax: 35, tempMin: 18, tempMax: 30, companeras: ['albahaca','cebollin','zanahoria'], enemigos: ['brocoli','repollo'] },
    { id: 'tomate_cherry',         nombre: 'Tomate Cherry',         emoji: 'ğŸ…', grupo: 'invernadero', dias: '60-75', espaciamiento: 40, humMin: 20, humMax: 35, tempMin: 18, tempMax: 32, companeras: ['albahaca','cebollin','zanahoria'], enemigos: ['brocoli','repollo'] },
    { id: 'tomate_chonto',         nombre: 'Tomate Chonto',         emoji: 'ğŸ…', grupo: 'invernadero', dias: '70-85', espaciamiento: 50, humMin: 20, humMax: 35, tempMin: 18, tempMax: 30, companeras: ['albahaca','cebollin','zanahoria'], enemigos: ['brocoli','repollo'] },
    { id: 'albahaca_invernadero',  nombre: 'Albahaca (Invernadero)',emoji: 'ğŸŒ¿', grupo: 'invernadero', dias: '50-70', espaciamiento: 25, humMin: 25, humMax: 45, tempMin: 15, tempMax: 30, companeras: ['tomate'],                          enemigos: ['salvia','ruda'] },
  ];

  /** Quick lookup map: plantId -> plant object */
  const PLANT_MAP = Object.fromEntries(PLANT_CATALOG.map(p => [p.id, p]));

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DEFAULT BED PLANT ASSIGNMENTS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const DEFAULT_BED_PLANTS = {
    cama1:       ['lechuga_batavia', 'lechuga_romana', 'lechuga_crespa'],
    cama2:       ['rucula', 'espinaca'],
    cama3:       ['acelga_comun', 'acelga_roja', 'acelga_amarilla'],
    cama4:       ['mizuna_verde', 'mizuna_roja', 'mostaza_red'],
    cama5:       ['albahaca', 'cilantro', 'perejil_liso'],
    cama6:       ['cebollin', 'oregano', 'tomillo'],
    cama7:       ['brocoli'],
    cama8:       ['coliflor_blanca', 'coliflor_verde'],
    cama9:       ['repollo_verde', 'repollo_morado'],
    cama10:      ['kale_toscano', 'kale_rizado'],
    cama11:      ['brocoli', 'coliflor_blanca'],
    cama12:      ['cebolla_larga', 'zanahoria', 'remolacha'],
    invernadero: ['tomate_san_marzano', 'tomate_cherry', 'tomate_chonto'],
  };

  /** localStorage key for plant assignments */
  const LS_KEY = 'huerta_bed_plants';

  /** localStorage keys for sensor assignment system */
  const LS_SENSOR_ASSIGNMENTS = 'huerta_sensor_assignments';
  const LS_BED_READINGS        = 'huerta_bed_readings';

  /** Default physical sensor placement */
  const DEFAULT_SENSOR_ASSIGNMENTS = {
    cama1:       'soil_ch2',
    cama2:       'soil_ch5',
    cama3:       'soil_ch1',
    cama4:       'soil_ch3',
    cama5:       null,
    cama6:       null,
    cama7:       null,
    cama8:       null,
    cama9:       null,
    cama10:      null,
    cama11:      null,
    cama12:      null,
    invernadero: 'soil_ch4',
  };

  /**
   * Load sensor-to-bed assignments from localStorage or use defaults.
   * @returns {Object<string, string|null>}
   */
  function loadSensorAssignments() {
    try {
      const raw = localStorage.getItem(LS_SENSOR_ASSIGNMENTS);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object' && parsed !== null) {
          return parsed;
        }
      }
    } catch (e) {
      console.warn('Failed to parse sensor assignments:', e);
    }
    return JSON.parse(JSON.stringify(DEFAULT_SENSOR_ASSIGNMENTS));
  }

  /**
   * Save sensor-to-bed assignments to localStorage.
   * @param {Object<string, string|null>} data
   */
  function saveSensorAssignments(data) {
    try {
      localStorage.setItem(LS_SENSOR_ASSIGNMENTS, JSON.stringify(data));
    } catch (e) {
      console.warn('Failed to save sensor assignments:', e);
    }
  }

  /**
   * Load last-known bed readings cache from localStorage.
   * @returns {Object<string, { humidity: number, timestamp: number, sensor: string }>}
   */
  function loadBedReadings() {
    try {
      const raw = localStorage.getItem(LS_BED_READINGS);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (typeof parsed === 'object' && parsed !== null) {
          return parsed;
        }
      }
    } catch (e) {
      console.warn('Failed to parse bed readings:', e);
    }
    return {};
  }

  /**
   * Save bed readings cache to localStorage.
   * @param {Object} data
   */
  function saveBedReadings(data) {
    try {
      localStorage.setItem(LS_BED_READINGS, JSON.stringify(data));
    } catch (e) {
      console.warn('Failed to save bed readings:', e);
    }
  }

  /**
   * Reverse lookup: which bed (if any) is currently using this sensor key.
   * @param {string} sensorKey - e.g. 'soil_ch1'
   * @returns {string|null} bedId or null
   */
  function getSensorBed(sensorKey) {
    const assignments = loadSensorAssignments();
    for (const [bedId, assigned] of Object.entries(assignments)) {
      if (assigned === sensorKey) return bedId;
    }
    return null;
  }

  /**
   * Assign a sensor to a bed.  Auto-unassigns it from any other bed first.
   * Pass null/empty string as sensorKey to remove sensor from the bed.
   * @param {string} bedId
   * @param {string|null} sensorKey
   */
  function assignSensorToBed(bedId, sensorKey) {
    const assignments = loadSensorAssignments();

    // Normalize empty string to null
    const newKey = sensorKey || null;

    // If this sensor is already in another bed, clear it there first
    if (newKey) {
      for (const [bid, assigned] of Object.entries(assignments)) {
        if (bid !== bedId && assigned === newKey) {
          assignments[bid] = null;
        }
      }
    }

    assignments[bedId] = newKey;
    saveSensorAssignments(assignments);

    // Re-render the entire bed map with the cached last API data
    refreshBedCardsOnly();
  }

  /**
   * Format a relative time string from a millisecond timestamp.
   * @param {number} timestampMs
   * @returns {string}
   */
  function timeAgo(timestampMs) {
    const diff = Date.now() - timestampMs;
    const mins = Math.floor(diff / 60000);
    if (mins < 1)  return 'ahora';
    if (mins < 60) return `hace ${mins}min`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24)  return `hace ${hrs}h`;
    const days = Math.floor(hrs / 24);
    return `hace ${days}d`;
  }

  /**
   * Build the sensor select dropdown options for a given bed.
   * @param {string} bedId
   * @param {string|null} assignedSensor - currently assigned sensor key for this bed
   * @param {Object<string,string|null>} assignments - full assignment map
   * @returns {string} HTML string of <option> elements
   */
  function buildSensorOptions(bedId, assignedSensor, assignments) {
    let html = '<option value="">Sin sensor</option>';
    SOIL_CHANNELS.forEach(ch => {
      const isSelected = assignedSensor === ch.key;
      // Check if assigned to ANOTHER bed
      const occupiedBy = Object.entries(assignments).find(
        ([bid, sk]) => bid !== bedId && sk === ch.key
      );
      const chNum = ch.key.replace('soil_ch', 'CH');
      let label = `ğŸ“¡ ${chNum}`;
      if (occupiedBy) {
        // Find bed name for display
        const occBed = BEDS.find(b => b.id === occupiedBy[0]);
        const occName = occBed ? occBed.name : (occupiedBy[0] === 'invernadero' ? 'Invernadero' : occupiedBy[0]);
        label += ` (en ${occName})`;
      }
      html += `<option value="${ch.key}"${isSelected ? ' selected' : ''}>${label}</option>`;
    });
    return html;
  }

  /**
   * Load bed plant assignments from localStorage or fall back to defaults.
   * @returns {Object<string, string[]>}
   */
  function loadBedPlants() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        // Validate: must be an object with string arrays
        if (typeof parsed === 'object' && parsed !== null) {
          return parsed;
        }
      }
    } catch (e) {
      console.warn('Failed to parse localStorage plant data:', e);
    }
    return JSON.parse(JSON.stringify(DEFAULT_BED_PLANTS)); // deep copy
  }

  /**
   * Save bed plant assignments to localStorage.
   * @param {Object<string, string[]>} data
   */
  function saveBedPlants(data) {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    } catch (e) {
      console.warn('Failed to save plant data to localStorage:', e);
    }
  }

  /** Live bed plant assignments (mutable, persisted to localStorage) */
  let BED_PLANTS = loadBedPlants();

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CONFIG
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const CONFIG = {
    applicationKey:          '2A298127832EF7B5F0495F16B07F7B5E',
    apiKey:                  '83b66e21-a6cf-445f-b14e-2810189d3e6d',
    mac:                     '8C:4F:00:4F:C1:E6',
    apiBase:                 'https://api.ecowitt.net/api/v3',
    unitParams:              'temp_unitid=1&pressure_unitid=3&rainfall_unitid=12',
    refreshInterval:         300000,   // 5 min (real-time)
    historyRefreshInterval:  1800000,  // 30 min (history)
    soilAlertThreshold:      35,
    soilOptimalMin:          50,
    soilOptimalMax:          80,
  };

  /* Channel labels & chart colours */
  const SOIL_CHANNELS = [
    { key: 'soil_ch1', label: 'CH1 â€” Cama 3 (Hojas)',         color: '#00D68F' },
    { key: 'soil_ch2', label: 'CH2 â€” Cama 1 (Hojas)',         color: '#4ECDC4' },
    { key: 'soil_ch3', label: 'CH3 â€” Cama 4 (Hojas)',         color: '#A855F7' },
    { key: 'soil_ch4', label: 'CH4 â€” Invernadero (Tomate)',   color: '#FFB800' },
    { key: 'soil_ch5', label: 'CH5 â€” Cama 2 (Hojas)',         color: '#FF6B6B' },
  ];

  const BATTERY_SENSOR_NAMES = {
    outdoor_t_rh_sensor:        'Exterior (WH32)',
    temp_humidity_sensor_ch1:   'Termo CH1 (WN31)',
    soilmoisture_sensor_ch1:    'Suelo CH1',
    soilmoisture_sensor_ch2:    'Suelo CH2',
    soilmoisture_sensor_ch3:    'Suelo CH3',
    soilmoisture_sensor_ch4:    'Suelo CH4',
    soilmoisture_sensor_ch5:    'Suelo CH5',
  };

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     BED MAP DATA
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /**
   * Sensor-to-bed mapping.
   * beds: which bed IDs share this sensor reading.
   */
  const SENSOR_BED_MAP = {
    'soil_ch1': { beds: ['cama3', 'cama5', 'cama7'],    label: 'CH1 â†’ Cama 3 (+ 5,7)',    group: 'hojas',    sensorIn: 'Cama 3' },
    'soil_ch2': { beds: ['cama1', 'cama2', 'cama4'],    label: 'CH2 â†’ Cama 1 (+ 2,4)',    group: 'hojas',    sensorIn: 'Cama 1' },
    'soil_ch3': { beds: ['cama6', 'cama8', 'cama9'],    label: 'CH3 â†’ Cama 4 (+ 6,8,9)',  group: 'hojas',    sensorIn: 'Cama 4' },
    'soil_ch4': { beds: ['invernadero'],                 label: 'CH4 â†’ Invernadero',        group: 'tomate',   sensorIn: 'Invernadero' },
    'soil_ch5': { beds: ['cama10', 'cama11', 'cama12'], label: 'CH5 â†’ Cama 2 (+ 10-12)',  group: 'hojas',    sensorIn: 'Cama 2' },
  };

  /** Crop-specific moisture thresholds (separate from cloud-forest bars above). */
  const CROP_THRESHOLDS = {
    hojas:    { optMin: 30, optMax: 45, alert: 28, critical: 22, label: 'Hojas' },
    hierbas:  { optMin: 30, optMax: 45, alert: 28, critical: 22, label: 'Hierbas' },
    brasicas: { optMin: 25, optMax: 40, alert: 22, critical: 18, label: 'BrÃ¡sicas' },
    tomate:   { optMin: 20, optMax: 30, alert: 18, critical: 15, label: 'Tomate' },
    rotacion: { optMin: 25, optMax: 40, alert: 22, critical: 18, label: 'RotaciÃ³n' },
  };

  /** Full bed definitions â€” impares = derecha, pares = izquierda. */
  const BEDS = [
    { id: 'cama1',  name: 'Cama 1',  group: 'hojas',    crops: ['ğŸ¥¬ Lechuga'],                                sensor: 'soil_ch2', hasSensor: true },
    { id: 'cama2',  name: 'Cama 2',  group: 'hojas',    crops: ['ğŸ¥— RÃºcula', 'ğŸ¥¬ Espinaca'],                  sensor: 'soil_ch5', hasSensor: true },
    { id: 'cama3',  name: 'Cama 3',  group: 'hojas',    crops: ['ğŸ¥¬ Acelga'],                                 sensor: 'soil_ch1', hasSensor: true },
    { id: 'cama4',  name: 'Cama 4',  group: 'hojas',    crops: ['ğŸ¥¬ Espinaca', 'ğŸŒ¿ Mostaza'],                 sensor: 'soil_ch3', hasSensor: true },
    { id: 'cama5',  name: 'Cama 5',  group: 'hierbas',  crops: ['ğŸŒ¿ Albahaca', 'ğŸŒ¿ Cilantro', 'ğŸŒ¿ Perejil'],  sensor: 'soil_ch1' },
    { id: 'cama6',  name: 'Cama 6',  group: 'hierbas',  crops: ['ğŸŒ¿ CebollÃ­n', 'ğŸŒ¿ OrÃ©gano', 'ğŸŒ¿ Tomillo'],   sensor: 'soil_ch3' },
    { id: 'cama7',  name: 'Cama 7',  group: 'brasicas',  crops: ['ğŸ¥¦ BrÃ³coli'],                                sensor: 'soil_ch1' },
    { id: 'cama8',  name: 'Cama 8',  group: 'brasicas',  crops: ['ğŸ¥¦ Coliflor'],                               sensor: 'soil_ch3' },
    { id: 'cama9',  name: 'Cama 9',  group: 'brasicas',  crops: ['ğŸ¥¬ Repollo'],                                sensor: 'soil_ch3' },
    { id: 'cama10', name: 'Cama 10', group: 'brasicas',  crops: ['ğŸ¥¬ Kale'],                                   sensor: 'soil_ch5' },
    { id: 'cama11', name: 'Cama 11', group: 'brasicas',  crops: ['ğŸ¥¦ BrÃ³coli', 'ğŸ¥¦ Coliflor'],                 sensor: 'soil_ch5' },
    { id: 'cama12', name: 'Cama 12', group: 'rotacion',  crops: ['ğŸ”„ RotaciÃ³n'],                               sensor: 'soil_ch5' },
  ];

  /** Group display labels. */
  const GROUP_LABELS = {
    hojas:    'Hojas',
    hierbas:  'Hierbas',
    brasicas: 'BrÃ¡sicas',
    rotacion: 'RotaciÃ³n',
  };

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let historyChart       = null;
  let countdownSeconds   = CONFIG.refreshInterval / 1000;
  let countdownTimer     = null;
  let lastDataTimestamp  = null;

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UTILS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /**
   * Format a Date to HH:MM (local, Colombia UTC-5).
   * @param {Date} date
   * @returns {string}
   */
  function formatTime(date) {
    return date.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: false });
  }

  /**
   * Format a Date to a readable datetime string.
   * @param {Date} date
   * @returns {string}
   */
  function formatDatetime(date) {
    return date.toLocaleString('es-CO', {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false,
    });
  }

  /**
   * Get a UTC date string for the Ecowitt history API.
   * @param {Date} date - Date object (will be interpreted as local; we shift to UTC manually)
   * @returns {string} "YYYY-MM-DD HH:MM:SS"
   */
  function toApiDateString(date) {
    const pad = n => String(n).padStart(2, '0');
    return `${date.getUTCFullYear()}-${pad(date.getUTCMonth()+1)}-${pad(date.getUTCDate())} ${pad(date.getUTCHours())}:${pad(date.getUTCMinutes())}:${pad(date.getUTCSeconds())}`;
  }

  /**
   * Determine soil bar colour from moisture percentage (cloud forest thresholds).
   * @param {number} pct
   * @returns {string}
   */
  function soilColor(pct) {
    if (pct < CONFIG.soilAlertThreshold)  return '#FF4757'; // red â€” dry
    if (pct < CONFIG.soilOptimalMin)       return '#FFB800'; // yellow â€” getting dry
    if (pct <= CONFIG.soilOptimalMax)      return '#00D68F'; // green â€” optimal
    return '#4ECDC4';                                        // blue â€” very wet
  }

  /**
   * Determine bed card glow class and humidity colour using crop-specific thresholds.
   * @param {number|null} pct
   * @param {string} group
   * @returns {{ glowClass: string, color: string }}
   */
  function bedHumidityStatus(pct, group) {
    if (pct === null) return { glowClass: '', color: 'var(--muted)' };
    const t = CROP_THRESHOLDS[group] || CROP_THRESHOLDS.rotacion;
    if (pct < t.critical)             return { glowClass: 'glow-red',    color: '#FF4757' };
    if (pct < t.alert)                return { glowClass: 'glow-yellow', color: '#FFB800' };
    if (pct >= t.optMin && pct <= t.optMax) return { glowClass: 'glow-green', color: '#00D68F' };
    if (pct > t.optMax)               return { glowClass: 'glow-blue',   color: '#4ECDC4' };
    // between critical and optMin (dry but not alarming)
    return { glowClass: 'glow-yellow', color: '#FFB800' };
  }

  /**
   * Safely parse a numeric value from the API (string | undefined).
   * @param {string|undefined} val
   * @returns {number|null}
   */
  function parseVal(val) {
    const n = parseFloat(val);
    return isNaN(n) ? null : n;
  }

  /**
   * Build the base URL params shared across requests.
   * @returns {string}
   */
  function baseParams() {
    return `application_key=${CONFIG.applicationKey}&api_key=${CONFIG.apiKey}&mac=${encodeURIComponent(CONFIG.mac)}&${CONFIG.unitParams}`;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     API FETCH: REAL-TIME
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchRealtime() {
    const url = `${CONFIG.apiBase}/device/real_time?${baseParams()}&call_back=all`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (json.code !== 0) throw new Error(`API error: ${json.msg}`);
    return json.data;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     API FETCH: HISTORY (last 24 h)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchHistory() {
    const now   = new Date();
    const start = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const fields = 'outdoor.temperature,soil_ch1,soil_ch2,soil_ch3,soil_ch4,soil_ch5';
    const url = `${CONFIG.apiBase}/device/history?${baseParams()}&call_back=${fields}&start_date=${encodeURIComponent(toApiDateString(start))}&end_date=${encodeURIComponent(toApiDateString(now))}&cycle_type=5min`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (json.code !== 0) throw new Error(`API error: ${json.msg}`);
    return json.data;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: STATUS DOT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateStatusDot(unixTimestamp) {
    const dot = document.getElementById('statusDot');
    if (!unixTimestamp) { dot.className = 'status-dot'; return; }
    const ageMs = Date.now() - (unixTimestamp * 1000);
    const ageMins = ageMs / 60000;
    if (ageMins < 10)       { dot.className = 'status-dot green'; }
    else if (ageMins < 30)  { dot.className = 'status-dot yellow'; }
    else                    { dot.className = 'status-dot red'; }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: KPI CARDS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateKPI(data) {
    const outdoor  = data.outdoor  || {};
    const rainfall = data.rainfall || {};
    const pressure = data.pressure || {};

    const tempExt  = parseVal(outdoor.temperature?.value);
    const feelsLike= parseVal(outdoor.feels_like?.value);
    const dewPoint = parseVal(outdoor.dew_point?.value);
    const humExt   = parseVal(outdoor.humidity?.value);
    const pressRel = parseVal(pressure.relative?.value);
    const pressAbs = parseVal(pressure.absolute?.value);
    const rainDay  = parseVal(rainfall.daily?.value);
    const rainRate = parseVal(rainfall.rain_rate?.value);

    setText('kpiTempExt',    tempExt   !== null ? tempExt.toFixed(1)   : 'â€”');
    setText('kpiFeelsLike',  feelsLike !== null ? `SensaciÃ³n: ${feelsLike.toFixed(1)}Â°C` : 'SensaciÃ³n: â€”');
    setText('kpiHumExt',     humExt    !== null ? Math.round(humExt)   : 'â€”');
    setText('kpiDewPoint',   dewPoint  !== null ? `RocÃ­o: ${dewPoint.toFixed(1)}Â°C` : 'RocÃ­o: â€”');
    setText('kpiPressure',   pressRel  !== null ? pressRel.toFixed(1)  : 'â€”');
    setText('kpiAbsPressure',pressAbs  !== null ? `Abs: ${pressAbs.toFixed(1)} hPa` : 'Abs: â€”');
    setText('kpiRainDay',    rainDay   !== null ? rainDay.toFixed(1)   : 'â€”');
    setText('kpiRainRate',   rainRate  !== null ? `Tasa: ${rainRate.toFixed(1)} mm/hr` : 'Tasa: â€” mm/hr');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: SOIL CHANNELS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateSoil(data) {
    const container = document.getElementById('soilChannels');
    container.innerHTML = '';

    const values = [];

    SOIL_CHANNELS.forEach(ch => {
      const raw = data[ch.key]?.soilmoisture?.value;
      const pct = parseVal(raw);
      if (pct === null) return; // skip missing channels
      values.push(pct);

      const color = soilColor(pct);
      const widthPct = Math.min(Math.max(pct, 0), 100);

      const row = document.createElement('div');
      row.className = 'channel-row';
      row.innerHTML = `
        <div class="channel-label">${ch.label.split(' â€” ')[0]}</div>
        <div class="progress-track">
          <div class="progress-fill" style="width:${widthPct}%;background:${color}"></div>
          <div class="threshold-marker dry"  data-label="35%"></div>
          <div class="threshold-marker opt"  data-label="50%"></div>
          <div class="threshold-marker wet"  data-label="80%"></div>
        </div>
        <div class="channel-pct" style="color:${color}">${Math.round(pct)}%</div>
      `;
      container.appendChild(row);
    });

    // Average
    if (values.length > 0) {
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      const avgEl = document.getElementById('soilAvgValue');
      avgEl.textContent = Math.round(avg) + '%';
      avgEl.style.color = soilColor(avg);
    }

    checkAlerts(data);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     CHECK: IRRIGATION ALERTS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function checkAlerts(data) {
    const banner = document.getElementById('alertBanner');
    const items  = document.getElementById('alertItems');
    items.innerHTML = '';

    const sensorAssignments = loadSensorAssignments();
    const needsWater = [];

    // Only alert for beds that have an active sensor assigned
    Object.entries(sensorAssignments).forEach(([bedId, sensorKey]) => {
      if (!sensorKey) return; // no sensor â€” skip
      const pct = parseVal(data[sensorKey]?.soilmoisture?.value);
      if (pct === null) return;

      // Find the bed group for crop-specific thresholds
      const bed = BEDS.find(b => b.id === bedId);
      const group = bed ? bed.group : (bedId === 'invernadero' ? 'tomate' : 'hojas');
      const t = CROP_THRESHOLDS[group] || CROP_THRESHOLDS.hojas;

      if (pct < t.alert) {
        const chNum = sensorKey.replace('soil_ch', 'CH');
        const bedName = bed ? bed.name : (bedId === 'invernadero' ? 'Invernadero' : bedId);
        needsWater.push({
          label: `${chNum} (${bedName})`,
          pct,
          critical: pct < t.critical,
        });
      }
    });

    if (needsWater.length > 0) {
      needsWater.forEach(({ label, pct, critical }) => {
        const div = document.createElement('div');
        div.className = 'alert-item';
        const icon = critical ? 'ğŸš¨' : 'âš ';
        const msg = critical ? 'riego urgente' : 'necesita riego';
        div.textContent = `${icon} ${label} ${msg} â€” ${Math.round(pct)}% humedad`;
        items.appendChild(div);
      });
      banner.classList.add('visible');
    } else {
      banner.classList.remove('visible');
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: CLIMA COMPLETO
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateClima(data) {
    const outdoor = data.outdoor || {};
    const indoor  = data.indoor  || {};
    const ch1     = data.temp_and_humidity_ch1 || {};

    const fmt = (val, unit) => val !== null ? `${val}${unit}` : 'â€”';

    setText('climaTempExt',   fmt(parseVal(outdoor.temperature?.value), 'Â°C'));
    setText('climaTempInt',   fmt(parseVal(indoor.temperature?.value),  'Â°C'));
    setText('climaHumExt',    fmt(parseVal(outdoor.humidity?.value),    '%'));
    setText('climaHumInt',    fmt(parseVal(indoor.humidity?.value),     '%'));
    setText('climaDewPoint',  fmt(parseVal(outdoor.dew_point?.value),   'Â°C'));
    setText('climaFeelsLike', fmt(parseVal(outdoor.feels_like?.value),  'Â°C'));
    setText('climaTempCh1',   fmt(parseVal(ch1.temperature?.value),     'Â°C'));
    setText('climaHumCh1',    fmt(parseVal(ch1.humidity?.value),        '%'));
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: RAIN SECTION
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateRain(data) {
    const r = data.rainfall || {};
    const fmt = (val, decimals = 1) => val !== null ? val.toFixed(decimals) : 'â€”';

    setText('rainRateValue', fmt(parseVal(r.rain_rate?.value)));
    setText('rain1h',   fmt(parseVal(r['1_hour']?.value)) + ' mm');
    setText('rainDay2', fmt(parseVal(r.daily?.value))    + ' mm');
    setText('rainWeek', fmt(parseVal(r.weekly?.value))   + ' mm');
    setText('rainMonth',fmt(parseVal(r.monthly?.value))  + ' mm');
    setText('rainYear', fmt(parseVal(r.yearly?.value))   + ' mm');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: BATTERY TABLE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateBattery(data) {
    const battery = data.battery || {};
    const tbody   = document.getElementById('batteryTableBody');
    tbody.innerHTML = '';

    Object.entries(battery).forEach(([key, batt]) => {
      const name  = BATTERY_SENSOR_NAMES[key] || key;
      const unit  = batt.unit;
      const value = parseVal(batt.value);
      if (value === null) return;

      let levelText, badgeClass, icon;

      if (unit === 'V') {
        // Voltage sensor (soil moisture sensors)
        levelText = `${value.toFixed(2)} V`;
        if (value >= 1.4) {
          badgeClass = 'ok';     icon = 'â—';
        } else if (value >= 1.2) {
          badgeClass = 'medium'; icon = 'â—‘';
        } else {
          badgeClass = 'low';    icon = 'â—‹';
        }
      } else {
        // Status code sensor (0 = OK, â‰¥5 = low)
        levelText = value === 0 ? 'Normal' : `CÃ³digo ${value}`;
        if (value === 0) {
          badgeClass = 'ok';     icon = 'â—';
        } else if (value < 5) {
          badgeClass = 'medium'; icon = 'â—‘';
        } else {
          badgeClass = 'low';    icon = 'â—‹';
        }
      }

      const statusLabel = { ok: 'Buena', medium: 'Media', low: 'Baja' }[badgeClass];

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${name}</td>
        <td>${levelText}</td>
        <td><span class="batt-badge ${badgeClass}"><span class="batt-icon">${icon}</span>${statusLabel}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: BED MAP
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /**
   * Build crop item HTML for a plant ID or fallback string.
   * @param {string} plantId
   * @returns {string}
   */
  function buildCropItemHtml(plantId) {
    const plant = PLANT_MAP[plantId];
    if (plant) {
      return `<div class="bed-crop-item" data-plant-id="${plant.id}"
                   onmouseenter="showPlantTooltip(event, '${plant.id}')"
                   onmouseleave="hidePlantTooltip()"
                   onmousemove="movePlantTooltip(event)">${plant.emoji} ${plant.nombre}</div>`;
    }
    // Fallback: treat as raw emoji string
    return `<div class="bed-crop-item">${plantId}</div>`;
  }

  /**
   * Render a single bed card element.
   * @param {object} bed - Bed definition from BEDS array
   * @param {number|null} humidity - Humidity value (live or cached) or null
   * @param {boolean} isLive - True if the humidity comes from a currently assigned sensor
   * @param {number|null} cachedTimestamp - Epoch ms of last cached reading (when not live)
   * @returns {HTMLElement}
   */
  function renderBedCard(bed, humidity, isLive, cachedTimestamp) {
    const { glowClass, color } = bedHumidityStatus(humidity, bed.group);
    const t = CROP_THRESHOLDS[bed.group] || CROP_THRESHOLDS.rotacion;

    const card = document.createElement('div');
    card.className = `bed-card${glowClass ? ' ' + glowClass : ''}`;
    card.dataset.group = bed.group;
    card.dataset.bedId = bed.id;

    const groupLabel = GROUP_LABELS[bed.group] || bed.group;

    // Use BED_PLANTS (from localStorage) as source of truth for crops
    const plantIds = BED_PLANTS[bed.id] || bed.crops || [];
    const cropsHtml = plantIds.map(id => buildCropItemHtml(id)).join('');

    // Build sensor selector
    const assignments = loadSensorAssignments();
    const assignedSensor = assignments[bed.id] || null;
    const sensorOptionsHtml = buildSensorOptions(bed.id, assignedSensor, assignments);
    const sensorRowHtml = `
      <div class="bed-sensor-row">
        <select class="bed-sensor-select" onchange="assignSensorToBed('${bed.id}', this.value)">
          ${sensorOptionsHtml}
        </select>
      </div>
    `;

    // Build humidity display
    let humidityHtml;
    if (humidity !== null && isLive) {
      humidityHtml = `
        <div style="display:flex;align-items:baseline;flex-wrap:wrap;gap:0.1rem">
          <div class="bed-humidity" style="color:${color}">${Math.round(humidity)}%</div>
          <span class="bed-live-badge">En vivo</span>
        </div>
        <div class="bed-humidity-sub">Ã“ptimo: ${t.optMin}â€“${t.optMax}%</div>
      `;
    } else if (humidity !== null && cachedTimestamp) {
      humidityHtml = `
        <div class="bed-humidity-cached" style="color:${color}">${Math.round(humidity)}%</div>
        <div class="bed-cached-info">Ãšltimo: ${timeAgo(cachedTimestamp)}</div>
      `;
    } else {
      humidityHtml = `<div class="bed-no-sensor">Sin datos</div>`;
    }

    card.innerHTML = `
      <button class="bed-edit-btn" onclick="openPlantModal('${bed.id}')" title="Editar plantas">âœï¸</button>
      <div class="bed-card-name">${bed.name} Â· ${groupLabel}</div>
      <div class="bed-card-crops">${cropsHtml}</div>
      ${sensorRowHtml}
      ${humidityHtml}
    `;

    return card;
  }

  /**
   * Update the visual bed map with live humidity data using the sensor assignment system.
   * @param {object} data - Ecowitt real-time API data object
   */
  function updateBedMap(data) {
    const sensorAssignments = loadSensorAssignments();
    const bedReadings = loadBedReadings();

    // Cache for lightweight re-renders (stores the raw API data)
    _lastApiData = data;

    const rowOdd  = document.getElementById('bedsRow1'); // impares (derecha)
    const rowEven = document.getElementById('bedsRow2'); // pares (izquierda)
    rowOdd.innerHTML = '';
    rowEven.innerHTML = '';

    BEDS.forEach(bed => {
      const assignedSensor = sensorAssignments[bed.id] || null;
      let humidity = null;
      let isLive = false;
      let cachedTimestamp = null;

      if (assignedSensor) {
        // Try to get live reading from assigned sensor
        const liveVal = parseVal(data[assignedSensor]?.soilmoisture?.value);
        if (liveVal !== null) {
          humidity = liveVal;
          isLive = true;
          // Cache this reading
          bedReadings[bed.id] = { humidity: liveVal, timestamp: Date.now(), sensor: assignedSensor };
        }
      }

      if (!isLive && bedReadings[bed.id]) {
        // Fall back to cached reading
        humidity = bedReadings[bed.id].humidity;
        cachedTimestamp = bedReadings[bed.id].timestamp;
      }

      const card = renderBedCard(bed, humidity, isLive, cachedTimestamp);
      const bedNum = parseInt(bed.id.replace('cama', ''), 10);
      if (bedNum % 2 === 1) {
        rowOdd.appendChild(card);  // 1,3,5,7,9,11
      } else {
        rowEven.appendChild(card); // 2,4,6,8,10,12
      }
    });

    // Save updated bed readings cache
    saveBedReadings(bedReadings);

    // Update greenhouse card
    const ghAssigned = sensorAssignments['invernadero'] || null;
    let ghHum = null;
    let ghIsLive = false;
    let ghCachedTs = null;

    if (ghAssigned) {
      const liveGh = parseVal(data[ghAssigned]?.soilmoisture?.value);
      if (liveGh !== null) {
        ghHum = liveGh;
        ghIsLive = true;
        bedReadings['invernadero'] = { humidity: liveGh, timestamp: Date.now(), sensor: ghAssigned };
        saveBedReadings(bedReadings);
      }
    }
    if (!ghIsLive && bedReadings['invernadero']) {
      ghHum = bedReadings['invernadero'].humidity;
      ghCachedTs = bedReadings['invernadero'].timestamp;
    }

    _updateGreenhouseHumidity(ghHum, ghIsLive, ghCachedTs);
    _updateGreenhouseSensorSelect(sensorAssignments);

    // Update greenhouse crops display from BED_PLANTS
    renderGreenhouseCrops();
  }

  /**
   * Update the greenhouse humidity display.
   * @param {number|null} ghHum
   * @param {boolean} isLive
   * @param {number|null} cachedTs
   */
  function _updateGreenhouseHumidity(ghHum, isLive, cachedTs) {
    const ghEl   = document.getElementById('greenhouseHumidity');
    const ghCard = document.getElementById('greenhouseCard');
    const ghLabel= document.getElementById('greenhouseDimsLabel');

    if (ghHum !== null) {
      ghEl.textContent = Math.round(ghHum) + '%';
      const t = CROP_THRESHOLDS.tomate;
      if (ghHum < t.critical)                        { ghEl.style.color = '#FF4757'; ghCard.style.borderLeftColor = '#FF4757'; }
      else if (ghHum < t.alert)                      { ghEl.style.color = '#FFB800'; ghCard.style.borderLeftColor = '#FFB800'; }
      else if (ghHum >= t.optMin && ghHum <= t.optMax){ ghEl.style.color = '#00D68F'; ghCard.style.borderLeftColor = '#00D68F'; }
      else                                            { ghEl.style.color = '#4ECDC4'; ghCard.style.borderLeftColor = '#4ECDC4'; }

      if (isLive) {
        ghLabel.innerHTML = 'Humedad suelo <span class="bed-live-badge">En vivo</span>';
      } else if (cachedTs) {
        ghLabel.textContent = `Ãšltimo: ${timeAgo(cachedTs)}`;
      } else {
        ghLabel.textContent = 'Humedad suelo';
      }
    } else {
      ghEl.textContent = 'â€”';
      ghLabel.textContent = 'Humedad suelo';
    }
  }

  /**
   * Update the greenhouse sensor select dropdown.
   * @param {Object<string, string|null>} assignments
   */
  function _updateGreenhouseSensorSelect(assignments) {
    const select = document.getElementById('greenhouseSensorSelect');
    if (!select) return;
    const assignedSensor = assignments['invernadero'] || null;
    select.innerHTML = buildSensorOptions('invernadero', assignedSensor, assignments);
  }

  /**
   * Render the greenhouse crops row from BED_PLANTS['invernadero'].
   * Also refreshes the sensor select dropdown.
   */
  function renderGreenhouseCrops() {
    const cropsEl = document.getElementById('greenhouseCropsDisplay');
    if (!cropsEl) return;
    const plantIds = BED_PLANTS['invernadero'] || DEFAULT_BED_PLANTS['invernadero'];
    cropsEl.innerHTML = plantIds.map(id => {
      const plant = PLANT_MAP[id];
      if (plant) {
        return `<span class="greenhouse-crop"
                     data-plant-id="${plant.id}"
                     onmouseenter="showPlantTooltip(event, '${plant.id}')"
                     onmouseleave="hidePlantTooltip()"
                     onmousemove="movePlantTooltip(event)"
                     style="cursor:help">${plant.emoji} ${plant.nombre}</span>`;
      }
      return `<span class="greenhouse-crop">${id}</span>`;
    }).join('');

    // Ensure greenhouse sensor select is populated on initial render
    const select = document.getElementById('greenhouseSensorSelect');
    if (select && select.options.length <= 1) {
      _updateGreenhouseSensorSelect(loadSensorAssignments());
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: NOTIFICATIONS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /**
   * Generate a list of notification objects from real-time sensor data.
   * @param {object} data - Ecowitt real-time API data object
   * @returns {Array<{ severity: string, icon: string, msg: string }>}
   */
  function generateNotifications(data) {
    const notifications = [];
    const now = formatTime(new Date());

    // â”€â”€ 1. Check soil channels against crop-specific thresholds
    // Only generate alerts for beds that have a sensor actively assigned
    const sensorAssignments = loadSensorAssignments();
    Object.entries(sensorAssignments).forEach(([bedId, sensorKey]) => {
      if (!sensorKey) return; // no sensor assigned to this bed

      const pct = parseVal(data[sensorKey]?.soilmoisture?.value);
      if (pct === null) return;

      const bed = BEDS.find(b => b.id === bedId);
      const group = bed ? bed.group : (bedId === 'invernadero' ? 'tomate' : 'hojas');
      const t = CROP_THRESHOLDS[group] || CROP_THRESHOLDS.rotacion;
      const groupLabel = t.label;
      const chNum = sensorKey.replace('soil_ch', 'CH');
      const bedName = bed ? bed.name : (bedId === 'invernadero' ? 'Invernadero' : bedId);
      const sensorLabel = `${chNum} â†’ ${bedName}`;

      if (pct < t.critical) {
        notifications.push({
          severity: 'critical',
          icon: 'ğŸš¨',
          msg: `${sensorLabel} (${groupLabel}): Humedad ${Math.round(pct)}% â€” Â¡Riego urgente! (crÃ­tico: <${t.critical}%)`,
        });
      } else if (pct < t.alert) {
        notifications.push({
          severity: 'warning',
          icon: 'âš ï¸',
          msg: `${sensorLabel} (${groupLabel}): Humedad ${Math.round(pct)}% â€” Riego recomendado (aviso: <${t.alert}%)`,
        });
      } else if (pct > t.optMax + 15) {
        notifications.push({
          severity: 'rain',
          icon: 'ğŸ’§',
          msg: `${sensorLabel} (${groupLabel}): Humedad ${Math.round(pct)}% â€” Suelo saturado, no regar`,
        });
      } else if (pct > t.optMax) {
        notifications.push({
          severity: 'info',
          icon: 'â„¹ï¸',
          msg: `${sensorLabel} (${groupLabel}): Humedad ${Math.round(pct)}% â€” Sobre el Ã³ptimo (mÃ¡x: ${t.optMax}%), reducir riego`,
        });
      }
    });

    // â”€â”€ 2. Battery low alerts
    const battery = data.battery || {};
    Object.entries(battery).forEach(([key, batt]) => {
      if (batt.unit !== 'V') return;
      const v = parseVal(batt.value);
      if (v !== null && v < 1.2) {
        const chMatch = key.match(/ch(\d+)/);
        const chLabel = chMatch ? `CH${chMatch[1]}` : key;
        notifications.push({
          severity: 'critical',
          icon: 'ğŸ”‹',
          msg: `Sensor ${chLabel} baterÃ­a baja: ${v.toFixed(2)}V â€” Cambiar pila`,
        });
      }
    });

    // â”€â”€ 3. Rain active
    const rainRate = parseVal(data.rainfall?.rain_rate?.value);
    if (rainRate !== null && rainRate > 0) {
      notifications.push({
        severity: 'rain',
        icon: 'ğŸŒ§ï¸',
        msg: `Lluvia activa: ${rainRate.toFixed(1)} mm/hr â€” Suspender riego manual`,
      });
    }

    // â”€â”€ 4. Low temperature alert
    const tempExt = parseVal(data.outdoor?.temperature?.value);
    if (tempExt !== null && tempExt < 8) {
      notifications.push({
        severity: 'warning',
        icon: 'ğŸ¥¶',
        msg: `Temperatura ${tempExt.toFixed(1)}Â°C â€” Proteger cultivos sensibles`,
      });
    }

    // â”€â”€ 5. All good fallback
    if (notifications.length === 0) {
      notifications.push({
        severity: 'info',
        icon: 'âœ…',
        msg: 'Todos los sensores en rango Ã³ptimo',
      });
    }

    return notifications;
  }

  /**
   * Render the notification center panel with current alerts.
   * @param {object} data - Ecowitt real-time API data object
   */
  function updateNotifications(data) {
    const notifications = generateNotifications(data);

    // Limit to 10 most recent (critical first, then warnings, then info)
    const sorted = [
      ...notifications.filter(n => n.severity === 'critical'),
      ...notifications.filter(n => n.severity === 'warning'),
      ...notifications.filter(n => n.severity === 'rain'),
      ...notifications.filter(n => n.severity === 'info'),
    ].slice(0, 10);

    // Count badges
    const critCount = notifications.filter(n => n.severity === 'critical').length;
    const warnCount = notifications.filter(n => n.severity === 'warning').length;

    const badgesEl = document.getElementById('notifBadges');
    badgesEl.innerHTML = '';
    if (critCount > 0) {
      const b = document.createElement('span');
      b.className = 'notif-badge critical';
      b.textContent = `${critCount} ğŸš¨`;
      badgesEl.appendChild(b);
    }
    if (warnCount > 0) {
      const b = document.createElement('span');
      b.className = 'notif-badge warning';
      b.textContent = `${warnCount} âš ï¸`;
      badgesEl.appendChild(b);
    }
    if (critCount === 0 && warnCount === 0) {
      const b = document.createElement('span');
      b.className = 'notif-badge info';
      b.textContent = 'Todo normal';
      badgesEl.appendChild(b);
    }

    // Timestamp
    setText('notifTimestamp', `Actualizado: ${formatTime(new Date())}`);

    // Render list
    const listEl = document.getElementById('notifList');
    listEl.innerHTML = '';

    if (sorted.length === 0) {
      const empty = document.createElement('div');
      empty.className = 'notif-empty';
      empty.textContent = 'Sin notificaciones';
      listEl.appendChild(empty);
      return;
    }

    sorted.forEach(notif => {
      const item = document.createElement('div');
      item.className = `notif-item severity-${notif.severity}`;
      item.innerHTML = `
        <div class="notif-icon">${notif.icon}</div>
        <div class="notif-msg">${notif.msg}</div>
        <div class="notif-time">${formatTime(new Date())}</div>
      `;
      listEl.appendChild(item);
    });
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     UPDATE: HISTORY CHART
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateHistory(data) {
    // Build datasets for soil channels
    const soilDatasets = SOIL_CHANNELS.map(ch => {
      const soilList = data[ch.key]?.soilmoisture?.list || {};
      const points = Object.entries(soilList).map(([ts, val]) => ({
        x: new Date(parseInt(ts, 10) * 1000),
        y: parseFloat(val),
      })).sort((a, b) => a.x - b.x);

      return {
        label:           ch.label,
        data:            points,
        borderColor:     ch.color,
        backgroundColor: ch.color + '18',
        borderWidth:     2,
        pointRadius:     0,
        pointHoverRadius:4,
        tension:         0.3,
        yAxisID:         'ySoil',
        fill:            false,
      };
    });

    // Temperature dataset (secondary Y)
    const tempList = data.outdoor?.temperature?.list || {};
    const tempPoints = Object.entries(tempList).map(([ts, val]) => ({
      x: new Date(parseInt(ts, 10) * 1000),
      y: parseFloat(val),
    })).sort((a, b) => a.x - b.x);

    const tempDataset = {
      label:           'Temp. Exterior (Â°C)',
      data:            tempPoints,
      borderColor:     '#FF8A95',
      backgroundColor: '#FF4757' + '10',
      borderWidth:     1.5,
      borderDash:      [4, 4],
      pointRadius:     0,
      pointHoverRadius:4,
      tension:         0.3,
      yAxisID:         'yTemp',
      fill:            false,
    };

    const allDatasets = [...soilDatasets, tempDataset];

    const annotations = {
      dryLine: {
        type: 'line',
        yMin: CONFIG.soilAlertThreshold,
        yMax: CONFIG.soilAlertThreshold,
        borderColor: 'rgba(255,71,87,0.6)',
        borderWidth: 1,
        borderDash: [6, 4],
        yScaleID: 'ySoil',
        label: { content: 'Riego 35%', display: true, position: 'end', color: '#FF4757', font: { size: 10 }, yAdjust: -8 },
      },
      wetLine: {
        type: 'line',
        yMin: CONFIG.soilOptimalMax,
        yMax: CONFIG.soilOptimalMax,
        borderColor: 'rgba(78,205,196,0.6)',
        borderWidth: 1,
        borderDash: [6, 4],
        yScaleID: 'ySoil',
        label: { content: 'Exceso 80%', display: true, position: 'end', color: '#4ECDC4', font: { size: 10 }, yAdjust: 8 },
      },
    };

    if (historyChart) {
      historyChart.data.datasets = allDatasets;
      historyChart.update('none');
    } else {
      const ctx = document.getElementById('historyChart').getContext('2d');
      historyChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: allDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#8888AA', font: { size: 11 }, boxWidth: 14, padding: 16 },
            },
            tooltip: {
              backgroundColor: '#1A1A2E',
              borderColor: '#2A2A4A',
              borderWidth: 1,
              titleColor: '#E8E8F0',
              bodyColor: '#8888AA',
              padding: 10,
              callbacks: {
                title: items => {
                  if (!items.length) return '';
                  return formatTime(items[0].raw.x);
                },
                label: item => {
                  const v = item.raw.y;
                  const unit = item.dataset.yAxisID === 'yTemp' ? 'Â°C' : '%';
                  return ` ${item.dataset.label}: ${v !== undefined ? v.toFixed(1) : 'â€”'}${unit}`;
                },
              },
            },
            annotation: { annotations },
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour', tooltipFormat: 'HH:mm', displayFormats: { hour: 'HH:mm' } },
              ticks: { color: '#8888AA', font: { size: 10 }, maxTicksLimit: 12 },
              grid:  { color: 'rgba(42,42,74,0.6)' },
            },
            ySoil: {
              type: 'linear',
              position: 'left',
              min: 0,
              max: 100,
              title: { display: true, text: 'Humedad del suelo (%)', color: '#8888AA', font: { size: 11 } },
              ticks: { color: '#8888AA', font: { size: 10 }, stepSize: 10 },
              grid:  { color: 'rgba(42,42,74,0.6)' },
            },
            yTemp: {
              type: 'linear',
              position: 'right',
              title: { display: true, text: 'Temperatura (Â°C)', color: '#FF8A95', font: { size: 11 } },
              ticks: { color: '#FF8A95', font: { size: 10 } },
              grid:  { drawOnChartArea: false },
            },
          },
        },
      });
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MAIN UPDATE DASHBOARD
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function updateDashboard(data) {
    // Determine timestamp for status dot (outdoor sensor time)
    const ts = parseInt(data.outdoor?.temperature?.time, 10) || null;
    lastDataTimestamp = ts;
    updateStatusDot(ts);

    // Last updated display
    setText('lastUpdated', formatDatetime(new Date()));

    updateKPI(data);
    updateSoil(data);
    updateBedMap(data);
    updateNotifications(data);
    updateClima(data);
    updateRain(data);
    updateBattery(data);
    checkBrowserAlerts(data);

    hideError('globalError');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     COUNTDOWN TIMER
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function startCountdown() {
    if (countdownTimer) clearInterval(countdownTimer);
    countdownSeconds = CONFIG.refreshInterval / 1000;

    countdownTimer = setInterval(() => {
      countdownSeconds--;
      if (countdownSeconds < 0) countdownSeconds = 0;
      const m = Math.floor(countdownSeconds / 60);
      const s = countdownSeconds % 60;
      setText('countdownDisplay', `${m}:${String(s).padStart(2, '0')}`);
    }, 1000);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     REFRESH BUTTON SPIN
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setRefreshSpinning(spinning) {
    const btn = document.getElementById('refreshBtn');
    if (spinning) btn.classList.add('spinning');
    else           btn.classList.remove('spinning');
    btn.disabled = spinning;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     LOAD REALTIME DATA
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadRealtime() {
    setRefreshSpinning(true);
    try {
      const data = await fetchRealtime();
      updateDashboard(data);
      startCountdown();
    } catch (err) {
      console.error('Realtime fetch error:', err);
      showError('globalError', `Error al obtener datos: ${err.message}. Se reintentarÃ¡ en ${CONFIG.refreshInterval / 60000} minutos.`);
    } finally {
      setRefreshSpinning(false);
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     LOAD HISTORY DATA
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function loadHistory() {
    try {
      const data = await fetchHistory();
      updateHistory(data);
      hideError('historyError');
    } catch (err) {
      console.error('History fetch error:', err);
      showError('historyError', `Error al cargar historial: ${err.message}`);
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     MANUAL REFRESH
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function manualRefresh() {
    loadRealtime();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     BROWSER PUSH NOTIFICATIONS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let notifPermission = Notification?.permission || 'denied';

  async function requestNotifPermission() {
    if (!('Notification' in window)) return;
    if (notifPermission === 'default') {
      notifPermission = await Notification.requestPermission();
    }
  }

  function sendBrowserNotif(title, body, tag) {
    if (notifPermission !== 'granted') return;
    try {
      new Notification(title, {
        body,
        icon: 'ğŸŒ±',
        tag, // prevents duplicate notifs with same tag
        requireInteraction: true,
      });
    } catch (e) { /* silent fail on iOS if not supported */ }
  }

  /**
   * Check data and fire browser notifications for critical conditions.
   * Called from updateDashboard after each refresh.
   */
  function checkBrowserAlerts(data) {
    if (notifPermission !== 'granted') return;

    const alerts = [];

    // Soil alerts â€” only for beds with an active sensor assignment
    const sensorAssignments = loadSensorAssignments();
    Object.entries(sensorAssignments).forEach(([bedId, sensorKey]) => {
      if (!sensorKey) return;
      const pct = parseVal(data[sensorKey]?.soilmoisture?.value);
      if (pct === null) return;
      const bed = BEDS.find(b => b.id === bedId);
      const group = bed ? bed.group : (bedId === 'invernadero' ? 'tomate' : 'hojas');
      const t = CROP_THRESHOLDS[group] || CROP_THRESHOLDS.rotacion;
      const chNum = sensorKey.replace('soil_ch', 'CH');
      const bedName = bed ? bed.name : (bedId === 'invernadero' ? 'Invernadero' : bedId);
      if (pct < t.critical) {
        alerts.push(`ğŸš¨ ${chNum} (${bedName}): ${Math.round(pct)}% â€” Â¡Riego urgente!`);
      } else if (pct < t.alert) {
        alerts.push(`âš ï¸ ${chNum} (${bedName}): ${Math.round(pct)}% â€” Riego recomendado`);
      }
    });

    // Rain alert
    const rainRate = parseVal(data.rainfall?.rain_rate?.value);
    if (rainRate !== null && rainRate > 0) {
      alerts.push(`ğŸŒ§ï¸ Lluvia activa: ${rainRate.toFixed(1)} mm/hr`);
    }

    // Frost alert
    const tempExt = parseVal(data.outdoor?.temperature?.value);
    if (tempExt !== null && tempExt < 8) {
      alerts.push(`ğŸ¥¶ Temperatura ${tempExt.toFixed(1)}Â°C â€” Proteger cultivos`);
    }

    // Battery alert
    const battery = data.battery || {};
    Object.entries(battery).forEach(([key, batt]) => {
      if (batt.unit === 'V' && parseVal(batt.value) < 1.2) {
        const name = BATTERY_SENSOR_NAMES[key] || key;
        alerts.push(`ğŸ”‹ ${name}: baterÃ­a baja ${batt.value}V`);
      }
    });

    // Send one combined notification if there are alerts
    if (alerts.length > 0) {
      sendBrowserNotif(
        `Huerto â€” ${alerts.length} alerta${alerts.length > 1 ? 's' : ''}`,
        alerts.join('\n'),
        'huerto-alert'
      );
    }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     DOM HELPERS
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function setText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
  }

  function showError(id, msg) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = msg;
    el.classList.add('visible');
  }

  function hideError(id) {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove('visible');
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     PLANT MODAL STATE
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let currentEditBedId = null; // which bed is being edited

  /**
   * Open the plant selection modal for a given bed ID.
   * @param {string} bedId - e.g. 'cama1', 'invernadero'
   */
  function openPlantModal(bedId) {
    currentEditBedId = bedId;

    // Set title
    const bed = BEDS.find(b => b.id === bedId);
    const titleEl = document.getElementById('plantModalTitle');
    if (bedId === 'invernadero') {
      titleEl.textContent = 'Editar plantas â€” Invernadero';
    } else if (bed) {
      titleEl.textContent = `Editar plantas â€” ${bed.name}`;
    } else {
      titleEl.textContent = `Editar plantas â€” ${bedId}`;
    }

    // Populate dropdown (filter by bed type)
    populatePlantDropdown(bedId);

    // Render current plants list
    renderCurrentPlantsList();

    // Show overlay
    document.getElementById('plantModalOverlay').classList.add('open');
  }

  /**
   * Close the plant modal and refresh the bed cards to reflect changes.
   */
  function closePlantModal() {
    document.getElementById('plantModalOverlay').classList.remove('open');
    currentEditBedId = null;
    // Re-render bed map to show updated plants (keep last known data)
    // We trigger a lightweight re-render using the last known humidity map
    refreshBedCardsOnly();
  }

  /**
   * Close modal when clicking the overlay (outside the modal card).
   * @param {MouseEvent} event
   */
  function handleOverlayClick(event) {
    if (event.target === document.getElementById('plantModalOverlay')) {
      closePlantModal();
    }
  }

  /**
   * Populate the plant selection <select> with groups.
   * @param {string} bedId
   */
  function populatePlantDropdown(bedId) {
    const select = document.getElementById('plantSelectDropdown');
    select.innerHTML = '<option value="">â€” Seleccionar planta â€”</option>';

    const isGreenhouse = bedId === 'invernadero';

    // Group order and labels
    const groups = isGreenhouse
      ? [{ key: 'invernadero', label: 'Invernadero' }]
      : [
          { key: 'hojas',      label: 'Hojas' },
          { key: 'aromaticas', label: 'AromÃ¡ticas' },
          { key: 'brasicas',   label: 'BrÃ¡sicas' },
          { key: 'raices',     label: 'RaÃ­ces' },
        ];

    const currentIds = BED_PLANTS[bedId] || [];

    groups.forEach(({ key, label }) => {
      const plants = PLANT_CATALOG.filter(p => p.grupo === key);
      if (plants.length === 0) return;

      const optgroup = document.createElement('optgroup');
      optgroup.label = label;

      plants.forEach(plant => {
        const opt = document.createElement('option');
        opt.value = plant.id;
        opt.textContent = `${plant.emoji} ${plant.nombre}`;
        if (currentIds.includes(plant.id)) {
          opt.disabled = true;
          opt.textContent += ' âœ“';
        }
        optgroup.appendChild(opt);
      });

      select.appendChild(optgroup);
    });

    // Disable add button if already at max 3
    updateAddButtonState();
  }

  /**
   * Render the list of currently assigned plants inside the modal.
   */
  function renderCurrentPlantsList() {
    const listEl = document.getElementById('plantCurrentList');
    const plantIds = BED_PLANTS[currentEditBedId] || [];

    if (plantIds.length === 0) {
      listEl.innerHTML = '<div class="plant-empty-msg">Sin plantas asignadas</div>';
      return;
    }

    listEl.innerHTML = plantIds.map(id => {
      const plant = PLANT_MAP[id];
      const label = plant ? `${plant.emoji} ${plant.nombre}` : id;
      return `
        <div class="plant-current-item">
          <span>${label}</span>
          <button class="plant-remove-btn" onclick="removePlantFromBed('${id}')" title="Quitar planta">âŒ</button>
        </div>
      `;
    }).join('');

    updateAddButtonState();
  }

  /**
   * Enable/disable the add button based on plant count.
   */
  function updateAddButtonState() {
    const addBtn = document.getElementById('plantAddBtn');
    const plantIds = BED_PLANTS[currentEditBedId] || [];
    addBtn.disabled = plantIds.length >= 3;
  }

  /**
   * Add the selected plant from the dropdown to the current bed.
   */
  function addPlantToCurrentBed() {
    if (!currentEditBedId) return;
    const select = document.getElementById('plantSelectDropdown');
    const plantId = select.value;
    if (!plantId) return;

    const currentIds = BED_PLANTS[currentEditBedId] || [];
    if (currentIds.length >= 3) return;
    if (currentIds.includes(plantId)) return;

    BED_PLANTS[currentEditBedId] = [...currentIds, plantId];
    saveBedPlants(BED_PLANTS);

    // Reset dropdown and re-render
    select.value = '';
    populatePlantDropdown(currentEditBedId);
    renderCurrentPlantsList();
  }

  /**
   * Remove a plant from the current bed assignment.
   * @param {string} plantId
   */
  function removePlantFromBed(plantId) {
    if (!currentEditBedId) return;
    const currentIds = BED_PLANTS[currentEditBedId] || [];
    BED_PLANTS[currentEditBedId] = currentIds.filter(id => id !== plantId);
    saveBedPlants(BED_PLANTS);

    populatePlantDropdown(currentEditBedId);
    renderCurrentPlantsList();
  }

  /**
   * Lightweight re-render of just the bed cards without making a new API call.
   * Uses the last known API data stored in state plus the current sensor assignments
   * and cached bed readings from localStorage.
   */
  let _lastApiData = null; // cache last raw API data

  function refreshBedCardsOnly() {
    const rowOdd  = document.getElementById('bedsRow1');
    const rowEven = document.getElementById('bedsRow2');
    if (!rowOdd || !rowEven) return;

    const sensorAssignments = loadSensorAssignments();
    const bedReadings = loadBedReadings();

    rowOdd.innerHTML = '';
    rowEven.innerHTML = '';

    BEDS.forEach(bed => {
      const assignedSensor = sensorAssignments[bed.id] || null;
      let humidity = null;
      let isLive = false;
      let cachedTimestamp = null;

      if (assignedSensor && _lastApiData) {
        const liveVal = parseVal(_lastApiData[assignedSensor]?.soilmoisture?.value);
        if (liveVal !== null) {
          humidity = liveVal;
          isLive = true;
        }
      }

      if (!isLive && bedReadings[bed.id]) {
        humidity = bedReadings[bed.id].humidity;
        cachedTimestamp = bedReadings[bed.id].timestamp;
      }

      const card = renderBedCard(bed, humidity, isLive, cachedTimestamp);
      const bedNum = parseInt(bed.id.replace('cama', ''), 10);
      if (bedNum % 2 === 1) {
        rowOdd.appendChild(card);
      } else {
        rowEven.appendChild(card);
      }
    });

    // Refresh greenhouse as well
    const ghAssigned = sensorAssignments['invernadero'] || null;
    let ghHum = null;
    let ghIsLive = false;
    let ghCachedTs = null;

    if (ghAssigned && _lastApiData) {
      const liveGh = parseVal(_lastApiData[ghAssigned]?.soilmoisture?.value);
      if (liveGh !== null) {
        ghHum = liveGh;
        ghIsLive = true;
      }
    }
    if (!ghIsLive && bedReadings['invernadero']) {
      ghHum = bedReadings['invernadero'].humidity;
      ghCachedTs = bedReadings['invernadero'].timestamp;
    }

    _updateGreenhouseHumidity(ghHum, ghIsLive, ghCachedTs);
    _updateGreenhouseSensorSelect(sensorAssignments);

    renderGreenhouseCrops();
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     PLANT TOOLTIP
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  /**
   * Show the plant info tooltip near the cursor.
   * @param {MouseEvent} event
   * @param {string} plantId
   */
  function showPlantTooltip(event, plantId) {
    const plant = PLANT_MAP[plantId];
    if (!plant) return;

    const tooltip = document.getElementById('plantTooltip');
    tooltip.innerHTML = `
      <div class="plant-tooltip-name">${plant.emoji} ${plant.nombre}</div>
      <div class="plant-tooltip-row"><span>Cosecha:</span><span>${plant.dias} dÃ­as</span></div>
      <div class="plant-tooltip-row"><span>Espacio:</span><span>${plant.espaciamiento} cm</span></div>
      <div class="plant-tooltip-row"><span>Hum. suelo:</span><span>${plant.humMin}â€“${plant.humMax}%</span></div>
      <div class="plant-tooltip-row"><span>Temp. Ã³ptima:</span><span>${plant.tempMin}â€“${plant.tempMax}Â°C</span></div>
    `;

    positionTooltip(event);
    tooltip.classList.add('visible');
  }

  /**
   * Hide the plant tooltip.
   */
  function hidePlantTooltip() {
    document.getElementById('plantTooltip').classList.remove('visible');
  }

  /**
   * Move tooltip to follow cursor.
   * @param {MouseEvent} event
   */
  function movePlantTooltip(event) {
    positionTooltip(event);
  }

  /**
   * Position the tooltip element near the mouse cursor.
   * @param {MouseEvent} event
   */
  function positionTooltip(event) {
    const tooltip = document.getElementById('plantTooltip');
    const offset = 14;
    let x = event.clientX + offset;
    let y = event.clientY + offset;

    // Prevent tooltip from going off-screen to the right
    const tooltipWidth = 220;
    if (x + tooltipWidth > window.innerWidth) {
      x = event.clientX - tooltipWidth - offset;
    }

    // Prevent overflow at bottom
    const tooltipHeight = tooltip.offsetHeight || 120;
    if (y + tooltipHeight > window.innerHeight) {
      y = event.clientY - tooltipHeight - offset;
    }

    tooltip.style.left = x + 'px';
    tooltip.style.top  = y + 'px';
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     INIT
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function init() {
    // Request notification permission on first load
    await requestNotifPermission();

    // Render greenhouse crops immediately from localStorage (no API needed)
    renderGreenhouseCrops();

    // Load both in parallel on first load
    await Promise.allSettled([loadRealtime(), loadHistory()]);

    // Schedule auto-refresh for real-time data
    setInterval(loadRealtime, CONFIG.refreshInterval);

    // Schedule auto-refresh for history
    setInterval(loadHistory, CONFIG.historyRefreshInterval);
  }

  // Kick off
  init();
  </script>
</body>
</html>
